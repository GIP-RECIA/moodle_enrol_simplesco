define ("enrol_simplesco/cohortenrolment",["exports","jquery","core/str","core/notification","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f){'use strict';Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=g(b);d=g(d);e=g(e);f=g(f);function g(a){return a&&a.__esModule?a:{default:a}}function h(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function i(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function j(a,b,c){if(b)i(a.prototype,b);if(c)i(a,c);return a}function k(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}var l={BUTTON_TRIGGER:"button#enrol_simplesco_addcohort",BUTTON_COLLAPSE:".collapsible .ftoggler a",BUTTON_LOADMORE:"button[data-toggle=\"load-more\"]",BUTTON_ENROL:"button[data-toggle=\"enrol\"]",BUTTON_SEARCH:"button#search",FIELD_TYPE:"input[name=\"enrol_simplesco_typesearch\"]",FIELD_ROLES:"select#enrol_simplesco_assignable_roles",FIELD_DURATION:"select#enrol_simplesco_assignable_duration",FIELD_SEARCH:"input#enrolusersearch",FIELD_STARTDATE:"select#enrol_simplesco_assignable_startdate",FIELD_COHORT_GROUP:"select[name=\"cohort_group\"]",AREA_RESULTS:"div#results"},m=function(){function a(b){h(this,a);k(this,"strings",null);k(this,"modal",null);k(this,"page",0);k(this,"perpage",25);k(this,"course_id",0);k(this,"role_default",0);k(this,"enrol_count",0);k(this,"assignales_roles",[]);k(this,"instance",[]);k(this,"start_dates",[]);k(this,"groups",[]);k(this,"require_refresh",!1);this.course_id=b.course_id;this.instance=b.instance;this.start_dates=b.start_dates;this.role_default=b.role_default;this.init()}j(a,[{key:"init",value:function init(){var a=this,g=(0,b.default)(l.BUTTON_TRIGGER);Promise.all([(0,c.get_strings)([{component:"enrol_simplesco",key:"enrolcohorttitle"},{component:"enrol_simplesco",key:"btnclosecohort"},{component:"role",key:"assignroles"},{component:"enrol",key:"none"},{component:"enrol",key:"enrolmentoptions"},{component:"moodle",key:"startingfrom"},{component:"enrol",key:"enrolperiod"},{component:"enrol",key:"unlimitedduration"},{component:"enrol_simplesco",key:"searchoption"},{component:"enrol",key:"usersearch"},{component:"enrol_simplesco",key:"noresultliste"},{component:"enrol_simplesco",key:"allresultliste"},{component:"enrol_simplesco",key:"ajaxxcohortfound"},{component:"enrol",key:"ajaxnext25"},{component:"enrol",key:"enrol"},{component:"enrol_simplesco",key:"cohort"},{component:"enrol_cohort",key:"addgroup"}]),e.default.create({type:e.default.types.DEFAULT,large:!0},g)]).then(function(b){a.strings=b[0];a.modal=b[1];a.modal.setTitle(a.strings[0]);var c="<div class=\"form-inline mform simplesco\">\n            <div class=\"form-group\">\n            <label for=\"enrol_simplesco_assignable_roles\">".concat(a.strings[2]," : </label>\n            <select id=\"enrol_simplesco_assignable_roles\"><option value=\"\">").concat(a.strings[3],"</option></select>\n            </div>\n            <fieldset class=\"collapsible collapsed\" id=\"enrolment_options\">\n            <legend class=\"ftoggler\"><a href=\"#\" class=\"fheader\" role=\"button\" aria-controls=\"enrolment_options\" \n                aria-expanded=\"false\">").concat(a.strings[4],"</a></legend>\n            <div class=\"fcontainer\">\n            <div class=\"startdate form-group\"><label for=\"enrol_simplesco_assignable_startdate\">").concat(a.strings[5],":</label> \n                <select id=\"enrol_simplesco_assignable_startdate\"></select></div>\n            <div class=\"duration form-group\"><label for=\"enrol_simplesco_assignable_duration\">").concat(a.strings[6]," :</label> \n                <select id=\"enrol_simplesco_assignable_duration\"><option value=\"0\" selected=\"selected\">").concat(a.strings[7],"\n                </option></select></div>\n            </div>\n            </fieldset>\n            <fieldset class=\"collapsible collapsed\" id=\"enrolment_searchs\">\n            <legend class=\"ftoggler\"><a href=\"#\" class=\"fheader\" role=\"button\" aria-controls=\"enrolment_options\" \n            aria-expanded=\"false\">").concat(a.strings[8],"</a></legend>\n            <div class=\"fcontainer\">\n            <label for=\"enrolusersearch\">").concat(a.strings[9]," :</label> <input type=\"text\" id=\"enrolusersearch\" value=\"\" \n                class=\"form-control\"/>\n            <div class=\"text-center\"><button class=\"btn btn-primary\" id=\"search\"> ").concat(a.strings[9],"</button></div>\n            </div>\n            </fieldset>\n            <div id=\"results\"></div>\n            <div id=\"loading\" style=\"display:none;\">CHARGEMENT</div>\n            </div>");a.modal.setBody(c);a.modal.setFooter("<button class=\"btn btn-primary\" data-action=\"hide\">".concat(a.strings[1],"</button>"));a.modal.getRoot().on(f.default.hidden,function(){if(a.require_refresh){location.reload()}});a.bindEvents();a.populateRoles();a.updateStartDateList();a.updateDurationsList()}).catch(d.default.exception)}},{key:"bindEvents",value:function bindEvents(){var a=this;document.addEventListener("click",function(b){if(b.target.closest(l.BUTTON_TRIGGER)){b.preventDefault();a.modal.show();a.modal.getBody().find(l.BUTTON_SEARCH).trigger("click")}});this.modal.getBody().find(l.BUTTON_COLLAPSE).on("click",function(a){a.preventDefault();a.target.closest(".collapsible").classList.toggle("collapsed");return!1});this.modal.getBody().find(l.BUTTON_SEARCH).on("click",function(b){b.preventDefault();a.search();return!1});this.modal.getBody().find(l.FIELD_SEARCH).on("keypress",function(b){if(13===b.which){b.preventDefault();a.search();return!1}});this.modal.getBody().on("click",l.BUTTON_LOADMORE,function(b){b.preventDefault();a.search(!0);return!1});this.modal.getBody().on("click",l.BUTTON_ENROL,function(c){c.preventDefault();var d=(0,b.default)(c.target).attr("value");a.enrol(d);return!1})}},{key:"enrol",value:function enrol(a){var c=this,e={id:this.course_id,sesskey:M.cfg.sesskey,action:"enrolcohort",enrolid:this.instance.id,cohortid:a,groupeid:this.modal.getBody().find(l.FIELD_COHORT_GROUP+"[rel=\""+a+"\"]").val(),role:this.modal.getBody().find(l.FIELD_ROLES).val(),startdate:this.modal.getBody().find(l.FIELD_STARTDATE).val(),duration:this.modal.getBody().find(l.FIELD_DURATION).val(),recovergrades:0};b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(e),success:function success(b){if(b.error){return d.default.exception(b)}c.require_refresh=!0;c.enrol_count++;c.modal.getBody().find(l.AREA_RESULTS).find("div.cohort[rel=\"'".concat(a,"\"]")).addClass("enrolled")},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){c.startLoading()}}).always(function(){c.stopLoading()})}},{key:"populateRoles",value:function populateRoles(){var a=this;if(0<this.assignales_roles.length){return this.updateRolesList()}b.default.ajax({url:M.cfg.wwwroot+"/enrol/ajax.php",method:"POST",dataType:"json",data:"id="+this.course_id+"&action=getassignable&sesskey="+M.cfg.sesskey,success:function success(b){if(b.error){return d.default.exception(b)}a.assignales_roles=b.response;a.updateRolesList()},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){a.startLoading()}}).always(function(){a.stopLoading()})}},{key:"renderCohort",value:function renderCohort(a){var b=this.modal.getBody().find(l.AREA_RESULTS).find(".cohort").length,c="<div class=\"cohort item clearfix\" rel=\"".concat(a.id,"\">\n            <div class=\"count\">").concat(b,"</div>\n            <div class=\"details\">\n            <div class=\"fullname\">").concat(a.name,"</div>\n            </div>\n            <div class=\"options\">\n            <select name=\"cohort_group\" rel=\"").concat(a.id,"\">");for(var d in this.groups){c+="<option value=\"".concat(d,"\">").concat(this.groups[d],"</option>")}c+="</select>\n            <button class=\"btn btn-success\" data-toggle=\"enrol\" value=\"".concat(a.id,"\">\n                ").concat(this.strings[14],"</button>\n            </div>\n            </div>");return c}},{key:"search",value:function search(a){var c=this;if(a){this.page++}else{this.page=0}var e={id:this.course_id,sesskey:M.cfg.sesskey,action:"searchcohorts",search:this.modal.getBody().find(l.FIELD_SEARCH).val(),page:this.page,perpage:this.perpage,enrolcount:this.enrol_count,enrolid:this.instance.id};this.modal.getBody().find(l.AREA_RESULTS).find("button[data-toggle=\"load-more\"]").remove();b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(e),success:function success(b){if(b.error){return d.default.exception(b)}if(!a){c.modal.getBody().find(l.AREA_RESULTS).html("");c.modal.getBody().find(l.AREA_RESULTS).append("<div class=\"total_results\">"+c.strings[12].replace("{$a}",b.response.totalcohorts)+"</div>");c.modal.getBody().find(l.AREA_RESULTS).append("<div class=\"item cohort clearfix\"><div class=\"count\">N\xB0</div><div class=\"details\">"+c.strings[14]+"</div><div class=\"options\">"+c.strings[15]+"</div></div>")}c.groups=b.response.group;for(var f in b.response.cohorts){var g=b.response.cohorts[f];c.modal.getBody().find(l.AREA_RESULTS).append(c.renderCohort(g))}var e=c.modal.getBody().find(l.AREA_RESULTS).find(".item").length-1;if(e<b.response.totalcohorts){c.modal.getBody().find(l.AREA_RESULTS).append("<div class=\"text-center\"><button class=\"btn btn-secondary\" data-toggle=\"load-more\">"+c.strings[13]+"</button></div>")}},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){c.startLoading()}}).always(function(){c.stopLoading()})}},{key:"startLoading",value:function startLoading(){this.modal.getBody().find("#loading").show()}},{key:"stopLoading",value:function stopLoading(){this.modal.getBody().find("#loading").hide()}},{key:"updateRolesList",value:function updateRolesList(){var a=this.modal.getBody().find(l.FIELD_ROLES);for(var c in this.assignales_roles){var d=this.role_default==this.assignales_roles[c].id?"selected=\"selected\"":"";(0,b.default)(a).append("<option value=\""+this.assignales_roles[c].id+"\" "+d+">"+this.assignales_roles[c].name+"</option>")}}},{key:"updateDurationsList",value:function updateDurationsList(){var a=this.modal.getBody().find(l.FIELD_DURATION);b.default.when((0,c.get_string)("durationdays","enrol","{a}")).then(function(c){for(var d=1;365>=d;d++){(0,b.default)(a).append("<option value=\""+d+"\">"+c.replace("{a}",d)+"</option>")}})}},{key:"updateStartDateList",value:function updateStartDateList(){var a=this.modal.getBody().find(l.FIELD_STARTDATE);for(var c in this.start_dates){(0,b.default)(a).append("<option value=\""+c+"\">"+this.start_dates[c]+"</option>")}}}]);return a}();a.init=function init(a){new m(a)}});
//# sourceMappingURL=cohortenrolment.min.js.map
