define ("enrol_simplesco/cohortenrolment",["exports","jquery","core/str","core/notification","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=g(b);c=g(c);d=g(d);e=g(e);f=g(f);var h=void 0;function g(a){return a&&a.__esModule?a:{default:a}}var j={BUTTON_TRIGGER:"button#enrol_simplesco_addcohort",BUTTON_COLLAPSE:".collapsible .ftoggler a",BUTTON_LOADMORE:"button[data-toggle=\"load-more\"]",BUTTON_ENROL:"button[data-toggle=\"enrol\"]",BUTTON_SEARCH:"button#search",FIELD_TYPE:"input[name=\"enrol_simplesco_typesearch\"]",FIELD_ROLES:"select#enrol_simplesco_assignable_roles",FIELD_DURATION:"select#enrol_simplesco_assignable_duration",FIELD_SEARCH:"input#enrolusersearch",FIELD_STARTDATE:"select#enrol_simplesco_assignable_startdate",FIELD_COHORT_GROUP:"select[name=\"cohort_group\"]",AREA_RESULTS:"div#results"},k=function(a){h.course_id=a.course_id;h.instance=a.instance;h.start_dates=a.start_dates;h.role_default=a.role_default;h.init()};k.prototype.modal=null;k.prototype.page=0;k.prototype.perpage=25;k.prototype.course_id=0;k.prototype.role_default=0;k.prototype.enrol_count=0;k.prototype.assignales_roles=[];k.prototype.instance=[];k.prototype.start_dates=[];k.prototype.groups=[];k.prototype.require_refresh=!1;k.prototype.init=function(){var a=(0,b.default)(j.BUTTON_TRIGGER);b.default.when(c.default.get_strings([{component:"enrol_simplesco",key:"enrolcohorttitle"},{component:"enrol_simplesco",key:"btnclosecohort"},{component:"role",key:"assignroles"},{component:"enrol",key:"none"},{component:"enrol",key:"enrolmentoptions"},{component:"moodle",key:"startingfrom"},{component:"enrol",key:"enrolperiod"},{component:"enrol",key:"unlimitedduration"},{component:"enrol_simplesco",key:"searchoption"},{component:"enrol",key:"usersearch"},{component:"enrol_simplesco",key:"noresultliste"},{component:"enrol_simplesco",key:"allresultliste"},{component:"enrol_simplesco",key:"ajaxxcohortfound"},{component:"enrol",key:"ajaxnext25"},{component:"enrol",key:"enrol"},{component:"enrol_simplesco",key:"cohort"},{component:"enrol_cohort",key:"addgroup"}]),e.default.create({type:e.default.types.DEFAULT,large:!0},a)).then(function(a,b){this.strings=a;this.modal=b;b.setTitle(a[0]);var c="<div class=\"form-inline mform simplesco\">";c+="<div class=\"form-group\">";c+="<label for=\"enrol_simplesco_assignable_roles\">"+a[2]+" : </label>";c+="<select id=\"enrol_simplesco_assignable_roles\"><option value=\"\">"+a[3]+"</option></select>";c+="</div>";c+="<fieldset class=\"collapsible collapsed\" id=\"enrolment_options\">";c+="<legend class=\"ftoggler\"><a href=\"#\" class=\"fheader\" role=\"button\" aria-controls=\"enrolment_options\" aria-expanded=\"false\">"+a[4]+"</a></legend>";c+="<div class=\"fcontainer\">";c+="<div class=\"startdate form-group\"><label for=\"enrol_simplesco_assignable_startdate\">"+a[5]+":</label> <select id=\"enrol_simplesco_assignable_startdate\"></select></div>";c+="<div class=\"duration form-group\"><label for=\"enrol_simplesco_assignable_duration\">"+a[6]+" :</label> <select id=\"enrol_simplesco_assignable_duration\"><option value=\"0\" selected=\"selected\">"+a[7]+"</option></select></div>";c+="</div>";c+="</fieldset>";c+="<fieldset class=\"collapsible collapsed\" id=\"enrolment_searchs\">";c+="<legend class=\"ftoggler\"><a href=\"#\" class=\"fheader\" role=\"button\" aria-controls=\"enrolment_options\" aria-expanded=\"false\">"+a[8]+"</a></legend>";c+="<div class=\"fcontainer\">";c+="<label for=\"enrolusersearch\">"+a[9]+" :</label> <input type=\"text\" id=\"enrolusersearch\" value=\"\" class=\"form-control\"/>";c+="<div class=\"text-center\"><button class=\"btn btn-primary\" id=\"search\"> "+a[9]+"</button></div>";c+="</div>";c+="</fieldset>";c+="<div id=\"results\"></div>";c+="<div id=\"loading\" style=\"display:none;\">CHARGEMENT</div>";c+="</div>";b.setBody(c);b.setFooter("<button class=\"btn btn-primary\" data-action=\"hide\">"+a[1]+"</button>");b.getRoot().on(f.default.hidden,function(){if((void 0).require_refresh){location.reload()}});this.bindEvents();this.populateRoles();this.updateStartDateList();this.updateDurationsList()}.bind(h)).fail(d.default.exception)};k.prototype.bindEvents=function(){(0,b.default)("body").on("click",j.BUTTON_TRIGGER,function(){(void 0).modal.show();(void 0).modal.getBody().find(j.BUTTON_SEARCH).trigger("click")});h.modal.getBody().find(j.BUTTON_COLLAPSE).on("click",function(a){a.preventDefault();(0,b.default)(h).closest(".collapsible").toggleClass("collapsed");return!1});h.modal.getBody().find(j.BUTTON_SEARCH).on("click",function(a){a.preventDefault();(void 0).search();return!1});h.modal.getBody().find(j.FIELD_SEARCH).on("keypress",function(a){if(13===a.which){a.preventDefault();(void 0).search();return!1}});h.modal.getBody().on("click",j.BUTTON_LOADMORE,function(a){a.preventDefault();(void 0).search(!0);return!1});h.modal.getBody().on("click",j.BUTTON_ENROL,function(a){a.preventDefault();var c=(0,b.default)(h).attr("value");(void 0).enrol(c);return!1})};k.prototype.enrol=function(a){var c={id:h.course_id,sesskey:M.cfg.sesskey,action:"enrolcohort",enrolid:h.instance.id,cohortid:a,groupeid:h.modal.getBody().find(j.FIELD_COHORT_GROUP+"[rel=\""+a+"\"]").val(),role:h.modal.getBody().find(j.FIELD_ROLES).val(),startdate:h.modal.getBody().find(j.FIELD_STARTDATE).val(),duration:h.modal.getBody().find(j.FIELD_DURATION).val(),recovergrades:0};b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(c),success:function success(b){if(b.error){return d.default.exception(b)}(void 0).require_refresh=!0;(void 0).enrol_count++;(void 0).modal.getBody().find(j.AREA_RESULTS).find("div.cohort[rel=\""+a+"\"]").addClass("enrolled")},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){(void 0).startLoading()}}).always(function(){(void 0).stopLoading()})};k.prototype.populateRoles=function(){if(0<h.assignales_roles.length){return h.updateRolesList()}b.default.ajax({url:M.cfg.wwwroot+"/enrol/ajax.php",method:"POST",dataType:"json",data:"id="+h.course_id+"&action=getassignable&sesskey="+M.cfg.sesskey,success:function success(a){if(a.error){return d.default.exception(a)}(void 0).assignales_roles=a.response;(void 0).updateRolesList()},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){(void 0).startLoading()}}).always(function(){(void 0).stopLoading()})};k.prototype.renderCohort=function(a){var b=h.modal.getBody().find(j.AREA_RESULTS).find(".cohort").length,c="<div class=\"cohort item clearfix\" rel=\""+a.id+"\">";c+="<div class=\"count\">"+b+"</div>";c+="<div class=\"details\">";c+="<div class=\"fullname\">"+a.name+"</div>";c+="</div>";c+="<div class=\"options\">";c+="<select name=\"cohort_group\" rel=\""+a.id+"\">";for(var d in h.groups){c+="<option value=\""+d+"\">"+h.groups[d]+"</option>"}c+="</select>";c+="<button class=\"btn btn-success\" data-toggle=\"enrol\" value=\""+a.id+"\">"+h.strings[14]+"</button>";c+="</div>";c+="</div>";return c};k.prototype.search=function(a){if(a){h.page++}else{h.page=0}var c={id:h.course_id,sesskey:M.cfg.sesskey,action:"searchcohorts",search:h.modal.getBody().find(j.FIELD_SEARCH).val(),page:h.page,perpage:h.perpage,enrolcount:h.enrol_count,enrolid:h.instance.id};(void 0).modal.getBody().find(j.AREA_RESULTS).find("button[data-toggle=\"load-more\"]").remove();b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(c),success:function success(b){if(b.error){return d.default.exception(b)}if(!a){(void 0).modal.getBody().find(j.AREA_RESULTS).html("");(void 0).modal.getBody().find(j.AREA_RESULTS).append("<div class=\"total_results\">"+(void 0).strings[12].replace("{$a}",b.response.totalcohorts)+"</div>");(void 0).modal.getBody().find(j.AREA_RESULTS).append("<div class=\"item cohort clearfix\"><div class=\"count\">N\xB0</div><div class=\"details\">"+(void 0).strings[14]+"</div><div class=\"options\">"+(void 0).strings[15]+"</div></div>")}(void 0).groups=b.response.group;for(var e in b.response.cohorts){var f=b.response.cohorts[e];(void 0).modal.getBody().find(j.AREA_RESULTS).append((void 0).renderCohort(f))}var c=(void 0).modal.getBody().find(j.AREA_RESULTS).find(".item").length-1;if(c<b.response.totalcohorts){(void 0).modal.getBody().find(j.AREA_RESULTS).append("<div class=\"text-center\"><button class=\"btn btn-secondary\" data-toggle=\"load-more\">"+(void 0).strings[13]+"</button></div>")}},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){(void 0).startLoading()}}).always(function(){(void 0).stopLoading()})};k.prototype.startLoading=function(){h.modal.getBody().find("#loading").show()};k.prototype.stopLoading=function(){h.modal.getBody().find("#loading").hide()};k.prototype.updateRolesList=function(){var a=h.modal.getBody().find(j.FIELD_ROLES);for(var c in h.assignales_roles){var d=h.role_default==h.assignales_roles[c].id?"selected=\"selected\"":"";(0,b.default)(a).append("<option value=\""+h.assignales_roles[c].id+"\" "+d+">"+h.assignales_roles[c].name+"</option>")}};k.prototype.updateDurationsList=function(){var a=h.modal.getBody().find(j.FIELD_DURATION);b.default.when(c.default.get_string("durationdays","enrol","{a}")).then(function(c){for(var d=1;365>=d;d++){(0,b.default)(a).append("<option value=\""+d+"\">"+c.replace("{a}",d)+"</option>")}})};k.prototype.updateStartDateList=function(){var a=h.modal.getBody().find(j.FIELD_STARTDATE);for(var c in h.start_dates){(0,b.default)(a).append("<option value=\""+c+"\">"+h.start_dates[c]+"</option>")}};a.init=function init(a){new k(a)}});
//# sourceMappingURL=cohortenrolment.min.js.map
