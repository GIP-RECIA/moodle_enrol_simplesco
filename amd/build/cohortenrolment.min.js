/*
  2016 Damyon Wiese <damyon@moodle.com>
 @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,d,g){a instanceof String&&(a=String(a));for(var h=a.length,f=0;f<h;f++){var k=a[f];if(d.call(g,k,f,a))return{i:f,v:k}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,g){a!=Array.prototype&&a!=Object.prototype&&(a[d]=g.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,d,g,h){if(d){g=$jscomp.global;a=a.split(".");for(h=0;h<a.length-1;h++){var f=a[h];f in g||(g[f]={});g=g[f]}a=a[a.length-1];h=g[a];d=d(h);d!=h&&null!=d&&$jscomp.defineProperty(g,a,{configurable:!0,writable:!0,value:d})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,g){return $jscomp.findInternal(this,a,g).v}},"es6","es3");
define('cohortenrolment',"core/templates jquery core/str core/config core/notification core/modal_factory core/modal_events core/fragment".split(" "),function(a,d,g,h,f,k,l,m){var e=function(c){this.course_id=c.course_id;this.instance=c.instance;this.start_dates=c.start_dates;this.role_default=c.role_default;this.init()};e.prototype.modal=null;e.prototype.page=0;e.prototype.perpage=25;e.prototype.course_id=0;e.prototype.role_default=0;e.prototype.enrol_count=0;e.prototype.assignales_roles=[];e.prototype.instance=[];
e.prototype.start_dates=[];e.prototype.groups=[];e.prototype.require_refresh=!1;e.prototype.init=function(){var c=d("button#enrol_simplesco_addcohort");d.when(g.get_strings([{component:"enrol_simplesco",key:"enrolcohorttitle"},{component:"enrol_simplesco",key:"btnclosecohort"},{component:"role",key:"assignroles"},{component:"enrol",key:"none"},{component:"enrol",key:"enrolmentoptions"},{component:"moodle",key:"startingfrom"},{component:"enrol",key:"enrolperiod"},{component:"enrol",key:"unlimitedduration"},
{component:"enrol_simplesco",key:"searchoption"},{component:"enrol",key:"usersearch"},{component:"enrol_simplesco",key:"noresultliste"},{component:"enrol_simplesco",key:"allresultliste"},{component:"enrol_simplesco",key:"ajaxxcohortfound"},{component:"enrol",key:"ajaxnext25"},{component:"enrol",key:"enrol"},{component:"enrol_simplesco",key:"cohort"},{component:"enrol_cohort",key:"addgroup"}]),k.create({type:k.types.DEFAULT,large:!0},c)).then(function(c,a){this.strings=c;this.modal=a;a.setTitle(c[0]);
var d='<div class="form-inline mform simplesco"><div class="form-group">'+('<label for="enrol_simplesco_assignable_roles">'+c[2]+" : </label>");d+='<select id="enrol_simplesco_assignable_roles"><option value="">'+c[3]+"</option></select>";d=d+'</div><fieldset class="collapsible collapsed" id="enrolment_options">'+('<legend class="ftoggler"><a href="#" class="fheader" role="button" aria-controls="enrolment_options" aria-expanded="false">'+c[4]+"</a></legend>");d=d+'<div class="fcontainer">'+('<div class="startdate form-group"><label for="enrol_simplesco_assignable_startdate">'+
c[5]+':</label> <select id="enrol_simplesco_assignable_startdate"></select></div>');d+='<div class="duration form-group"><label for="enrol_simplesco_assignable_duration">'+c[6]+' :</label> <select id="enrol_simplesco_assignable_duration"><option value="0" selected="selected">'+c[7]+"</option></select></div>";d=d+'</div></fieldset><fieldset class="collapsible collapsed" id="enrolment_searchs">'+('<legend class="ftoggler"><a href="#" class="fheader" role="button" aria-controls="enrolment_options" aria-expanded="false">'+
c[8]+"</a></legend>");d=d+'<div class="fcontainer">'+('<label for="enrolusersearch">'+c[9]+' :</label> <input type="text" id="enrolusersearch" value="" class="form-control"/>');d+='<div class="text-center"><button class="btn btn-primary" id="search"> '+c[9]+"</button></div>";a.setBody(d+'</div></fieldset><div id="results"></div><div id="loading" style="display:none;">CHARGEMENT</div></div>');a.setFooter('<button class="btn btn-primary" data-action="hide">'+c[1]+"</button>");a.getRoot().on(l.hidden,
function(){b.require_refresh&&location.reload()});this.bindEvents();this.populateRoles();this.updateStartDateList();this.updateDurationsList()}.bind(this)).fail(f.exception);var b=this};e.prototype.bindEvents=function(){var c=this;d("body").on("click","button#enrol_simplesco_addcohort",function(){c.modal.show();c.modal.getBody().find("button#search").trigger("click")});this.modal.getBody().find(".collapsible .ftoggler a").on("click",function(b){b.preventDefault();d(this).closest(".collapsible").toggleClass("collapsed");
return!1});this.modal.getBody().find("button#search").on("click",function(b){b.preventDefault();c.search();return!1});this.modal.getBody().find("input#enrolusersearch").on("keypress",function(b){if(13===b.which)return b.preventDefault(),c.search(),!1});this.modal.getBody().on("click",'button[data-toggle="load-more"]',function(b){b.preventDefault();c.search(!0);return!1});this.modal.getBody().on("click",'button[data-toggle="enrol"]',function(b){b.preventDefault();b=d(this).attr("value");c.enrol(b);
return!1})};e.prototype.enrol=function(c){var b=this,a={id:this.course_id,sesskey:M.cfg.sesskey,action:"enrolcohort",enrolid:this.instance.id,cohortid:c,groupeid:this.modal.getBody().find('select[name="cohort_group"][rel="'+c+'"]').val(),role:this.modal.getBody().find("select#enrol_simplesco_assignable_roles").val(),startdate:this.modal.getBody().find("select#enrol_simplesco_assignable_startdate").val(),duration:this.modal.getBody().find("select#enrol_simplesco_assignable_duration").val(),recovergrades:0};
d.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(a),success:function(a,d){if(a.error)return f.exception(a);b.require_refresh=!0;b.enrol_count++;b.modal.getBody().find("div#results").find('div.cohort[rel="'+c+'"]').addClass("enrolled")},error:function(b,c,a){f.exception(a)},beforeSend:function(){b.startLoading()}}).always(function(){b.stopLoading()})};e.prototype.populateRoles=function(){if(0<this.assignales_roles.length)return this.updateRolesList();
var c=this;d.ajax({url:M.cfg.wwwroot+"/enrol/ajax.php",method:"POST",dataType:"json",data:"id="+this.course_id+"&action=getassignable&sesskey="+M.cfg.sesskey,success:function(b,a){if(b.error)return f.exception(b);c.assignales_roles=b.response;c.updateRolesList()},error:function(b,c,a){f.exception(a)},beforeSend:function(){c.startLoading()}}).always(function(){c.stopLoading()})};e.prototype.renderCohort=function(c){var b=this.modal.getBody().find("div#results").find(".cohort").length,a='<div class="cohort item clearfix" rel="'+
c.id+'">';a=a+('<div class="count">'+b+"</div>")+'<div class="details">'+('<div class="fullname">'+c.name+"</div>");a+="</div>";a+='<div class="options">';a+='<select name="cohort_group" rel="'+c.id+'">';for(var d in this.groups)a+='<option value="'+d+'">'+this.groups[d]+"</option>";a+="</select>";a+='<button class="btn btn-success" data-toggle="enrol" value="'+c.id+'">'+this.strings[14]+"</button>";a+="</div>";return a+="</div>"};e.prototype.search=function(a){var b=this;a?this.page++:this.page=
0;var c={id:this.course_id,sesskey:M.cfg.sesskey,action:"searchcohorts",search:this.modal.getBody().find("input#enrolusersearch").val(),page:this.page,perpage:this.perpage,enrolcount:this.enrol_count,enrolid:this.instance.id};b.modal.getBody().find("div#results").find('button[data-toggle="load-more"]').remove();d.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(c),success:function(c,d){if(c.error)return f.exception(c);a||(b.modal.getBody().find("div#results").html(""),
b.modal.getBody().find("div#results").append('<div class="total_results">'+b.strings[12].replace("{$a}",c.response.totalcohorts)+"</div>"),b.modal.getBody().find("div#results").append('<div class="item cohort clearfix"><div class="count">N\u00b0</div><div class="details">'+b.strings[14]+'</div><div class="options">'+b.strings[15]+"</div></div>"));b.groups=c.response.group;for(var e in c.response.cohorts)d=c.response.cohorts[e],b.modal.getBody().find("div#results").append(b.renderCohort(d));b.modal.getBody().find("div#results").find(".item").length-
1<c.response.totalcohorts&&b.modal.getBody().find("div#results").append('<div class="text-center"><button class="btn btn-secondary" data-toggle="load-more">'+b.strings[13]+"</button></div>")},error:function(a,c,b){f.exception(b)},beforeSend:function(){b.startLoading()}}).always(function(){b.stopLoading()})};e.prototype.startLoading=function(){this.modal.getBody().find("#loading").show()};e.prototype.stopLoading=function(){this.modal.getBody().find("#loading").hide()};e.prototype.updateRolesList=function(){var a=
this.modal.getBody().find("select#enrol_simplesco_assignable_roles"),b;for(b in this.assignales_roles){var e=this.role_default==this.assignales_roles[b].id?'selected="selected"':"";d(a).append('<option value="'+this.assignales_roles[b].id+'" '+e+">"+this.assignales_roles[b].name+"</option>")}};e.prototype.updateDurationsList=function(){var a=this.modal.getBody().find("select#enrol_simplesco_assignable_duration");d.when(g.get_string("durationdays","enrol","{a}")).then(function(c){for(var b=1;365>=
b;b++)d(a).append('<option value="'+b+'">'+c.replace("{a}",b)+"</option>")})};e.prototype.updateStartDateList=function(){var a=this.modal.getBody().find("select#enrol_simplesco_assignable_startdate"),b;for(b in this.start_dates)d(a).append('<option value="'+b+'">'+this.start_dates[b]+"</option>")};return{init:function(a){new e(a)}}});
