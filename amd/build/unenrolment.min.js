define ("enrol_simplesco/unenrolment",["exports","jquery","core/str","core/notification","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=g(b);c=g(c);d=g(d);e=g(e);f=g(f);var h=void 0;function g(a){return a&&a.__esModule?a:{default:a}}var i={BUTTON_TRIGGER:".enrolusersbutton.enrol_simplesco_plugin.unenrol [type='submit']",BUTTON_LOADMORE:"button[data-toggle=\"load-more\"]",BUTTON_UNENROL:"button[data-toggle=\"unenrol\"]",BUTTON_UNENROL_ALL:"button[data-toggle=\"unenrol-all\"]",FIELD_ENTITY:"input[name=\"entity\"]",AREA_RESULTS:"div#results"},j=function(a){h.course_id=a.course_id;h.instance=a.instance;h.init()};j.prototype.modal=null;j.prototype.page=0;j.prototype.perpage=25;j.prototype.course_id=0;j.prototype.unenrol_count=0;j.prototype.instance=[];j.prototype.require_refresh=!1;j.prototype.modal=null;j.prototype.init=function(){b.default.when(c.default.get_strings([{component:"enrol_simplesco",key:"unenroltitle"},{component:"enrol_simplesco",key:"btnunenrolall"},{component:"enrol_simplesco",key:"btnclose"},{component:"enrol_simplesco",key:"browseusers"},{component:"enrol_simplesco",key:"browsecohorts"},{component:"enrol",key:"ajaxxusersfound"},{component:"enrol_simplesco",key:"ajaxxcohortfound"},{component:"enrol",key:"ajaxnext25"},{component:"enrol_simplesco",key:"unenrolusers"}]),e.default.create({type:e.default.types.DEFAULT,large:!0},void 0)).then(function(a,b){this.strings=a;this.modal=b;b.setTitle(a[0]);var c="<div class=\"form-inline mform simplesco\">";c+="<div class=\"search-control\">";c+="<div class=\"entity-selector\">";c+="<label><input type=\"radio\" name=\"entity\" value=\"users\" checked=\"checked\"/>"+a[3]+"</label>";c+="<label><input type=\"radio\" name=\"entity\" value=\"cohorts\"/>"+a[4]+"</label>";c+="</div>";c+="</div>";c+="<div id=\"results\"></div>";c+="<div id=\"loading\" style=\"display:none;\">CHARGEMENT</div>";c+="</div>";b.setBody(c);b.setFooter("<button class=\"btn btn-primary\" data-toggle=\"unenrol-all\">"+a[1]+"</button><button class=\"btn btn-primary\" data-action=\"hide\">"+a[2]+"</button>");b.getRoot().on(f.default.hidden,function(){if((void 0).require_refresh){location.reload()}});this.bindEvents();this.search()}.bind(h)).fail(d.default.exception)};j.prototype.bindEvents=function(){(0,b.default)("body").on("click",i.BUTTON_TRIGGER,function(){(void 0).modal.show()});h.modal.getBody().find(i.FIELD_ENTITY).on("change",function(){(void 0).search()});h.modal.getBody().on("click",i.BUTTON_LOADMORE,function(a){a.preventDefault();(void 0).search(!0);return!1});h.modal.getFooter().on("click",i.BUTTON_UNENROL_ALL,function(a){a.preventDefault();if(confirm("Vous allez d\xE9sinscrire tous les utilisateurs de ce cours ! Voulez-vous continuer ?")){(void 0).unenrolall()}return!1});h.modal.getBody().find(i.AREA_RESULTS).on("click",i.BUTTON_UNENROL,function(a){a.preventDefault();var c=(0,b.default)(h).attr("value");(void 0).unenrol(c);return!1})};j.prototype.search=function(a){if(a){h.page++}else{h.page=0}var c="searchusersenrol";if("cohorts"===h.modal.getBody().find(i.FIELD_ENTITY+":checked").val()){c="searchcohortsenrol"}var e={id:h.course_id,sesskey:M.cfg.sesskey,action:c,page:h.page,perpage:h.perpage,enrolcount:h.enrol_count,enrolid:h.instance.id};(void 0).modal.getBody().find(i.AREA_RESULTS).find("button[data-toggle=\"load-more\"]").remove();b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(e),success:function success(b){if(b.error){return d.default.exception(b)}var e=(void 0).strings[5].replace("{$a}",b.response.totalusers);if("searchcohortsenrol"===c){e=(void 0).strings[6].replace("{$a}",b.response.totalcohorts)}if(!a){(void 0).modal.getBody().find(i.AREA_RESULTS).html("");(void 0).modal.getBody().find(i.AREA_RESULTS).append("<div class=\"total_results\">"+e+"</div>")}if("searchcohortsenrol"===c){for(var g in b.response.cohorts){var h=b.response.cohorts[g];(void 0).modal.getBody().find(i.AREA_RESULTS).append((void 0).renderCohort(h))}}else{for(var j in b.response.users){var k=b.response.users[j];(void 0).modal.getBody().find(i.AREA_RESULTS).append((void 0).renderUser(k))}}var f=(void 0).modal.getBody().find(i.AREA_RESULTS).find(".item").length;if(f<b.response.totalusers){(void 0).modal.getBody().find(i.AREA_RESULTS).append("<div class=\"text-center\"><button class=\"btn btn-secondary\" data-toggle=\"load-more\">"+(void 0).strings[7]+"</button></div>")}},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){(void 0).startLoading()}}).always(function(){(void 0).stopLoading()})};j.prototype.renderCohort=function(a){var b=h.modal.getBody().find(i.AREA_RESULTS).find(".cohort").length,c="<div class=\"cohort item clearfix\" rel=\""+a.id+"\">";c+="<div class=\"count\">"+(b+1)+"</div>";c+="<div class=\"details\">";c+="<div class=\"fullname\">"+a.name+"</div>";c+="</div>";c+="<div class=\"options\">";c+="<button class=\"btn btn-success\" data-toggle=\"unenrol\" value=\""+a.id+"\">"+h.strings[8]+"</button>";c+="</div>";c+="</div>";return c};j.prototype.renderUser=function(a){var b=h.modal.getBody().find(i.AREA_RESULTS).find(".user").length,c="<div class=\"user item clearfix\" rel=\""+a.id+"\">";c+="<div class=\"count\">"+(b+1)+"</div>";c+="<div class=\"picture\">"+a.picture+"</div>";c+="<div class=\"details\">";c+="<div class=\"fullname\">"+a.fullname+"</div>";c+="<div class=\"extrafields\">"+a.extrafields+"</div>";c+="</div>";c+="<div class=\"options\">";c+="<button class=\"btn btn-success\" data-toggle=\"unenrol\" value=\""+a.id+"\">"+h.strings[8]+"</button>";c+="</div>";c+="</div>";return c};j.prototype.startLoading=function(){h.modal.getBody().find("#loading").show()};j.prototype.stopLoading=function(){h.modal.getBody().find("#loading").hide()};j.prototype.unenrol=function(a){var c={id:h.course_id,sesskey:M.cfg.sesskey,action:"enrolcohort",enrolid:h.instance.id};if("cohorts"===h.modal.getBody().find(i.FIELD_ENTITY+":checked").val()){c.cohortid=a;c.action="unenrolcohort"}else{c.userid=a;c.action="unenroluser"}b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(c),success:function success(b){if(b.error){return d.default.exception(b)}(void 0).require_refresh=!0;(void 0).unenrol_count++;(void 0).modal.getBody().find(i.AREA_RESULTS).find("div.item[rel=\""+a+"\"]").addClass("enrolled")},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){(void 0).startLoading()}}).always(function(){(void 0).stopLoading()})};j.prototype.unenrolall=function(){var a={id:h.course_id,sesskey:M.cfg.sesskey,action:"enrolcohort",enrolid:h.instance.id};if("cohorts"===h.modal.getBody().find(i.FIELD_ENTITY+":checked").val()){a.action="unenrolallcohort"}else{a.action="unenrolalluser"}b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(a),success:function success(a){if(a.error){return d.default.exception(a)}(void 0).require_refresh=!0;(void 0).hide()},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){(void 0).startLoading()}}).always(function(){(void 0).stopLoading()})};a.init=function init(a){new j(a)}});
//# sourceMappingURL=unenrolment.min.js.map
