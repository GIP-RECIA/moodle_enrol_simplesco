/*
  2016 Damyon Wiese <damyon@moodle.com>
 @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,e,g){a instanceof String&&(a=String(a));for(var k=a.length,f=0;f<k;f++){var l=a[f];if(e.call(g,l,f,a))return{i:f,v:l}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,e,g){a!=Array.prototype&&a!=Object.prototype&&(a[e]=g.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,e,g,k){if(e){g=$jscomp.global;a=a.split(".");for(k=0;k<a.length-1;k++){var f=a[k];f in g||(g[f]={});g=g[f]}a=a[a.length-1];k=g[a];e=e(k);e!=k&&null!=e&&$jscomp.defineProperty(g,a,{configurable:!0,writable:!0,value:e})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,g){return $jscomp.findInternal(this,a,g).v}},"es6","es3");
define('unenrolment',"core/templates jquery core/str core/config core/notification core/yui core/modal_factory core/modal_events core/fragment".split(" "),function(a,e,g,k,f,l,m,n,p){var d=function(h){this.course_id=h.course_id;this.instance=h.instance;this.init()};d.prototype.modal=null;d.prototype.page=0;d.prototype.perpage=25;d.prototype.course_id=0;d.prototype.unenrol_count=0;d.prototype.instance=[];d.prototype.require_refresh=!1;d.prototype.modal=null;d.prototype.init=function(){var h=this;e.when(g.get_strings([{component:"enrol_simplesco",
key:"unenroltitle"},{component:"enrol_simplesco",key:"btnunenrolall"},{component:"enrol_simplesco",key:"btnclose"},{component:"enrol_simplesco",key:"browseusers"},{component:"enrol_simplesco",key:"browsecohorts"},{component:"enrol",key:"ajaxxusersfound"},{component:"enrol_simplesco",key:"ajaxxcohortfound"},{component:"enrol",key:"ajaxnext25"},{component:"enrol_simplesco",key:"unenrolusers"}]),m.create({type:m.types.DEFAULT,large:!0},void 0)).then(function(b,c){this.strings=b;this.modal=c;c.setTitle(b[0]);
var a='<div class="form-inline mform simplesco"><div class="search-control"><div class="entity-selector">'+('<label><input type="radio" name="entity" value="users" checked="checked"/>'+b[3]+"</label>");a+='<label><input type="radio" name="entity" value="cohorts"/>'+b[4]+"</label>";c.setBody(a+'</div></div><div id="results"></div><div id="loading" style="display:none;">CHARGEMENT</div></div>');c.setFooter('<button class="btn btn-primary" data-toggle="unenrol-all">'+b[1]+'</button><button class="btn btn-primary" data-action="hide">'+
b[2]+"</button>");c.getRoot().on(n.hidden,function(){h.require_refresh&&location.reload()});this.bindEvents();this.search()}.bind(this)).fail(f.exception)};d.prototype.bindEvents=function(){var h=this;e("body").on("click",".enrolusersbutton.enrol_simplesco_plugin.unenrol [type='submit']",function(){h.modal.show()});this.modal.getBody().find('input[name="entity"]').on("change",function(b){h.search()});this.modal.getBody().on("click",'button[data-toggle="load-more"]',function(b){b.preventDefault();
h.search(!0);return!1});this.modal.getFooter().on("click",'button[data-toggle="unenrol-all"]',function(b){b.preventDefault();confirm("Vous allez d\u00e9sinscrire tous les utilisateurs de ce cours ! Voulez-vous continuer ?")&&h.unenrolall();return!1});this.modal.getBody().find("div#results").on("click",'button[data-toggle="unenrol"]',function(b){b.preventDefault();b=e(this).attr("value");h.unenrol(b);return!1})};d.prototype.search=function(h){var b=this;h?this.page++:this.page=0;var c="searchusersenrol";
"cohorts"===this.modal.getBody().find('input[name="entity"]:checked').val()&&(c="searchcohortsenrol");var a={id:this.course_id,sesskey:M.cfg.sesskey,action:c,page:this.page,perpage:this.perpage,enrolcount:this.enrol_count,enrolid:this.instance.id};b.modal.getBody().find("div#results").find('button[data-toggle="load-more"]').remove();e.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(a),success:function(a){if(a.error)return f.exception(a);var d=
b.strings[5].replace("{$a}",a.response.totalusers);"searchcohortsenrol"===c&&(d=b.strings[6].replace("{$a}",a.response.totalcohorts));h||(b.modal.getBody().find("div#results").html(""),b.modal.getBody().find("div#results").append('<div class="total_results">'+d+"</div>"));if("searchcohortsenrol"===c)for(var e in a.response.cohorts)d=a.response.cohorts[e],b.modal.getBody().find("div#results").append(b.renderCohort(d));else for(e in a.response.users)d=a.response.users[e],b.modal.getBody().find("div#results").append(b.renderUser(d));
b.modal.getBody().find("div#results").find(".item").length<a.response.totalusers&&b.modal.getBody().find("div#results").append('<div class="text-center"><button class="btn btn-secondary" data-toggle="load-more">'+b.strings[7]+"</button></div>")},error:function(a,b,c){f.exception(c)},beforeSend:function(){b.startLoading()}}).always(function(){b.stopLoading()})};d.prototype.renderCohort=function(a){var b=this.modal.getBody().find("div#results").find(".cohort").length,c='<div class="cohort item clearfix" rel="'+
a.id+'">';c=c+('<div class="count">'+(b+1)+"</div>")+'<div class="details">'+('<div class="fullname">'+a.name+"</div>");c+="</div>";c+='<div class="options">';c+='<button class="btn btn-success" data-toggle="unenrol" value="'+a.id+'">'+this.strings[8]+"</button>";c+="</div>";return c+="</div>"};d.prototype.renderUser=function(a){var b=this.modal.getBody().find("div#results").find(".user").length,c='<div class="user item clearfix" rel="'+a.id+'">';c=c+('<div class="count">'+(b+1)+"</div>")+('<div class="picture">'+
a.picture+"</div>");c=c+'<div class="details">'+('<div class="fullname">'+a.fullname+"</div>");c+='<div class="extrafields">'+a.extrafields+"</div>";c=c+'</div><div class="options">'+('<button class="btn btn-success" data-toggle="unenrol" value="'+a.id+'">'+this.strings[8]+"</button>");return c+"</div></div>"};d.prototype.startLoading=function(){this.modal.getBody().find("#loading").show()};d.prototype.stopLoading=function(){this.modal.getBody().find("#loading").hide()};d.prototype.unenrol=function(a){var b=
this,c={id:this.course_id,sesskey:M.cfg.sesskey,action:"enrolcohort",enrolid:this.instance.id};"cohorts"===this.modal.getBody().find('input[name="entity"]:checked').val()?(c.cohortid=a,c.action="unenrolcohort"):(c.userid=a,c.action="unenroluser");e.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(c),success:function(c){if(c.error)return f.exception(c);b.require_refresh=!0;b.unenrol_count++;b.modal.getBody().find("div#results").find('div.item[rel="'+
a+'"]').addClass("enrolled")},error:function(a,b,c){f.exception(c)},beforeSend:function(){b.startLoading()}}).always(function(){b.stopLoading()})};d.prototype.unenrolall=function(){var a=this,b={id:this.course_id,sesskey:M.cfg.sesskey,action:"enrolcohort",enrolid:this.instance.id};"cohorts"===this.modal.getBody().find('input[name="entity"]:checked').val()?b.action="unenrolallcohort":b.action="unenrolalluser";e.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(b),
success:function(b){if(b.error)return f.exception(b);a.require_refresh=!0;a.hide()},error:function(a,b,d){f.exception(d)},beforeSend:function(){a.startLoading()}}).always(function(){a.stopLoading()})};return{init:function(a){new d(a)}}});
