define ("enrol_simplesco/unenrolment",["exports","jquery","core/str","core/notification","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f){'use strict';Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=g(b);d=g(d);e=g(e);f=g(f);function g(a){return a&&a.__esModule?a:{default:a}}function h(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function i(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function j(a,b,c){if(b)i(a.prototype,b);if(c)i(a,c);return a}function k(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}var l={BUTTON_TRIGGER:".enrolusersbutton.enrol_simplesco_plugin.unenrol [type='submit']",BUTTON_LOADMORE:"button[data-toggle=\"load-more\"]",BUTTON_UNENROL:"button[data-toggle=\"unenrol\"]",BUTTON_UNENROL_ALL:"button[data-toggle=\"unenrol-all\"]",FIELD_ENTITY:"input[name=\"entity\"]",AREA_RESULTS:"div#results"},m=function(){function a(b){h(this,a);k(this,"strings",null);k(this,"modal",null);k(this,"page",0);k(this,"perpage",25);k(this,"course_id",0);k(this,"unenrol_count",0);k(this,"instance",[]);k(this,"require_refresh",!1);this.course_id=b.course_id;this.instance=b.instance;this.init()}j(a,[{key:"init",value:function init(){var a=this;Promise.all([(0,c.get_strings)([{component:"enrol_simplesco",key:"unenroltitle"},{component:"enrol_simplesco",key:"btnunenrolall"},{component:"enrol_simplesco",key:"btnclose"},{component:"enrol_simplesco",key:"browseusers"},{component:"enrol_simplesco",key:"browsecohorts"},{component:"enrol",key:"ajaxxusersfound"},{component:"enrol_simplesco",key:"ajaxxcohortfound"},{component:"enrol",key:"ajaxnext25"},{component:"enrol_simplesco",key:"unenrolusers"}]),e.default.create({type:e.default.types.DEFAULT,large:!0},void 0)]).then(function(b){a.strings=b[0];a.modal=b[1];a.modal.setTitle(a.strings[0]);var c="<div class=\"form-inline mform simplesco\">\n            <div class=\"search-control\">\n            <div class=\"entity-selector\">\n            <label><input type=\"radio\" name=\"entity\" value=\"users\" checked=\"checked\"/>".concat(a.strings[3],"</label>\n            <label><input type=\"radio\" name=\"entity\" value=\"cohorts\"/>").concat(a.strings[4],"</label>\n            </div>\n            </div>\n            <div id=\"results\"></div>\n            <div id=\"loading\" style=\"display:none;\">CHARGEMENT</div>\n            </div>");a.modal.setBody(c);a.modal.setFooter("<button class=\"btn btn-primary\" data-toggle=\"unenrol-all\">".concat(a.strings[1],"</button>\n            <button class=\"btn btn-primary\" data-action=\"hide\">").concat(a.strings[2],"</button>"));a.modal.getRoot().on(f.default.hidden,function(){if(a.require_refresh){location.reload()}});a.bindEvents();a.search()}).catch(d.default.exception)}},{key:"bindEvents",value:function bindEvents(){var a=this;document.addEventListener("click",function(b){if(b.target.closest(l.BUTTON_TRIGGER)){b.preventDefault();a.modal.show()}});this.modal.getBody().find(l.FIELD_ENTITY).on("change",function(){a.search()});this.modal.getBody().on("click",l.BUTTON_LOADMORE,function(b){b.preventDefault();a.search(!0);return!1});this.modal.getFooter().on("click",l.BUTTON_UNENROL_ALL,function(b){b.preventDefault();if(confirm("Vous allez d\xE9sinscrire tous les utilisateurs de ce cours ! Voulez-vous continuer ?")){a.unenrolall()}return!1});this.modal.getBody().find(l.AREA_RESULTS).on("click",l.BUTTON_UNENROL,function(c){c.preventDefault();var d=(0,b.default)(c.target).attr("value");a.unenrol(d);return!1})}},{key:"search",value:function search(a){var c=this;if(a){this.page++}else{this.page=0}var e="searchusersenrol";if("cohorts"===this.modal.getBody().find(l.FIELD_ENTITY+":checked").val()){e="searchcohortsenrol"}var f={id:this.course_id,sesskey:M.cfg.sesskey,action:e,page:this.page,perpage:this.perpage,enrolcount:this.enrol_count,enrolid:this.instance.id};this.modal.getBody().find(l.AREA_RESULTS).find("button[data-toggle=\"load-more\"]").remove();b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(f),success:function success(b){if(b.error){return d.default.exception(b)}var f=c.strings[5].replace("{$a}",b.response.totalusers);if("searchcohortsenrol"===e){f=c.strings[6].replace("{$a}",b.response.totalcohorts)}if(!a){c.modal.getBody().find(l.AREA_RESULTS).html("");c.modal.getBody().find(l.AREA_RESULTS).append("<div class=\"total_results\">".concat(f,"\n                        </div>"))}if("searchcohortsenrol"===e){for(var h in b.response.cohorts){var i=b.response.cohorts[h];c.modal.getBody().find(l.AREA_RESULTS).append(c.renderCohort(i))}}else{for(var j in b.response.users){var k=b.response.users[j];c.modal.getBody().find(l.AREA_RESULTS).append(c.renderUser(k))}}var g=c.modal.getBody().find(l.AREA_RESULTS).find(".item").length;if(g<b.response.totalusers){c.modal.getBody().find(l.AREA_RESULTS).append("<div class=\"text-center\"><button class=\"btn btn-secondary\" data-toggle=\"load-more\">'\n                            ".concat(c.strings[7],"</button></div>"))}},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){c.startLoading()}}).always(function(){c.stopLoading()})}},{key:"renderCohort",value:function renderCohort(a){var b=this.modal.getBody().find(l.AREA_RESULTS).find(".cohort").length,c="<div class=\"cohort item clearfix\" rel=\"".concat(a.id,"\">\n        <div class=\"count\">").concat(b+1,"</div>\n        <div class=\"details\">\n        <div class=\"fullname\">").concat(a.name,"</div>\n        </div>\n        <div class=\"options\">\n        <button class=\"btn btn-success\" data-toggle=\"unenrol\" value=\"").concat(a.id,"\">\n            ").concat(this.strings[8],"</button>\n        </div>\n        </div>");return c}},{key:"renderUser",value:function renderUser(a){var b=this.modal.getBody().find(l.AREA_RESULTS).find(".user").length,c="<div class=\"user item clearfix\" rel=\"".concat(a.id,"\">\n        <div class=\"count\">").concat(b+1,"</div>\n        <div class=\"picture\">").concat(a.picture,"</div>\n        <div class=\"details\">\n        <div class=\"fullname\">").concat(a.fullname,"</div>\n        <div class=\"extrafields\">").concat(a.extrafields,"</div>\n        </div>\n        <div class=\"options\">\n        <button class=\"btn btn-success\" data-toggle=\"unenrol\" value=\"").concat(a.id,"\">").concat(this.strings[8],"</button>\n        </div>\n        </div>");return c}},{key:"startLoading",value:function startLoading(){this.modal.getBody().find("#loading").show()}},{key:"stopLoading",value:function stopLoading(){this.modal.getBody().find("#loading").hide()}},{key:"unenrol",value:function unenrol(a){var c=this,e={id:this.course_id,sesskey:M.cfg.sesskey,action:"enrolcohort",enrolid:this.instance.id};if("cohorts"===this.modal.getBody().find(l.FIELD_ENTITY+":checked").val()){e.cohortid=a;e.action="unenrolcohort"}else{e.userid=a;e.action="unenroluser"}b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(e),success:function success(b){if(b.error){return d.default.exception(b)}c.require_refresh=!0;c.unenrol_count++;c.modal.getBody().find(l.AREA_RESULTS).find("div.item[rel=\"".concat(a,"\"]")).addClass("enrolled")},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){c.startLoading()}}).always(function(){c.stopLoading()})}},{key:"unenrolall",value:function unenrolall(){var a=this,c={id:this.course_id,sesskey:M.cfg.sesskey,action:"enrolcohort",enrolid:this.instance.id};if("cohorts"===this.modal.getBody().find(l.FIELD_ENTITY+":checked").val()){c.action="unenrolallcohort"}else{c.action="unenrolalluser"}b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(c),success:function success(b){if(b.error){return d.default.exception(b)}a.require_refresh=!0},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){a.startLoading()}}).always(function(){a.stopLoading()})}}]);return a}();a.init=function init(a){new m(a)}});
//# sourceMappingURL=unenrolment.min.js.map
