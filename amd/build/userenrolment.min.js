define ("enrol_simplesco/userenrolment",["exports","jquery","core/str","core/notification","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f){'use strict';Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=g(b);d=g(d);e=g(e);f=g(f);function g(a){return a&&a.__esModule?a:{default:a}}function h(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){h=function(a){return typeof a}}else{h=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return h(a)}function i(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function j(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function k(a,b,c){if(b)j(a.prototype,b);if(c)j(a,c);return a}function l(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}var m={BUTTON_TRIGGER:"button#enrol_simplesco_adduser",BUTTON_COLLAPSE:".collapsible .ftoggler a",BUTTON_LOADMORE:"button[data-toggle=\"load-more\"]",BUTTON_ENROL:"button[data-toggle=\"enrol\"]",BUTTON_SEARCH:"button#search",FIELD_TYPE:"input[name=\"enrol_simplesco_typesearch\"]",FIELD_ROLES:"select#enrol_simplesco_assignable_roles",FIELD_DURATION:"select#enrol_simplesco_assignable_duration",FIELD_SEARCH:"input#enrolusersearch",FIELD_STARTDATE:"select#enrol_simplesco_assignable_startdate",AREA_RESULTS:"div#results"},n=function(){function a(b){i(this,a);l(this,"strings",null);l(this,"modal",null);l(this,"page",0);l(this,"perpage",25);l(this,"course_id",0);l(this,"role_default",0);l(this,"enrol_count",0);l(this,"assignales_roles",[]);l(this,"instance",[]);l(this,"start_dates",[]);l(this,"require_refresh",!1);l(this,"modal",null);this.course_id=b.course_id;this.instance=b.instance;this.start_dates=b.start_dates;this.role_default=b.role_default;this.init()}k(a,[{key:"init",value:function init(){var a=this;Promise.all([(0,c.get_strings)([{component:"enrol",key:"enrolusers"},{component:"enrol",key:"finishenrollingusers"},{component:"role",key:"assignroles"},{component:"enrol",key:"none"},{component:"enrol",key:"enrolmentoptions"},{component:"moodle",key:"startingfrom"},{component:"enrol",key:"enrolperiod"},{component:"enrol",key:"unlimitedduration"},{component:"enrol_simplesco",key:"searchoption"},{component:"enrol_simplesco",key:"frommyclass"},{component:"enrol_simplesco",key:"fromnetocentre"},{component:"enrol_simplesco",key:"byname"},{component:"enrol_simplesco",key:"fitre1name"},{component:"enrol_simplesco",key:"fitre2name"},{component:"enrol_simplesco",key:"fitre3name"},{component:"enrol_simplesco",key:"fitre4name"},{component:"enrol_simplesco",key:"fitre5name"},{component:"enrol_simplesco",key:"fitre6name"},{component:"enrol",key:"usersearch"},{component:"enrol_simplesco",key:"noresultliste"},{component:"enrol_simplesco",key:"allresultliste"},{component:"enrol",key:"ajaxxusersfound"},{component:"enrol",key:"ajaxnext25"},{component:"enrol",key:"enrol"}]),e.default.create({type:e.default.types.DEFAULT,large:!0},void 0)]).then(function(b){a.strings=b[0];a.modal=b[1];a.modal.setTitle(a.strings[0]);var c="<div class=\"form-inline mform simplesco\">\n            <div class=\"form-group\">\n            <label for=\"enrol_simplesco_assignable_roles\">".concat(a.strings[2]," : </label>\n            <select id=\"enrol_simplesco_assignable_roles\"><option value=\"\">").concat(a.strings[3],"</option></select>\n            </div>\n            <fieldset class=\"collapsible collapsed\" id=\"enrolment_options\">\n            <legend class=\"ftoggler\"><a href=\"#\" class=\"fheader\" role=\"button\" aria-controls=\"enrolment_options\" \n                aria-expanded=\"false\">").concat(a.strings[4],"</a></legend>\n            <div class=\"fcontainer\">\n            <div class=\"startdate form-group\"><label for=\"enrol_simplesco_assignable_startdate\">").concat(a.strings[5]," \n                :</label> <select id=\"enrol_simplesco_assignable_startdate\"></select></div>\n            <div class=\"duration form-group\"><label for=\"enrol_simplesco_assignable_duration\">").concat(a.strings[6]," \n                :</label> <select id=\"enrol_simplesco_assignable_duration\"><option value=\"0\" selected=\"selected\">\n                ").concat(a.strings[7],"</option></select></div>\n            </div>\n            </fieldset>\n            <fieldset class=\"collapsible\" id=\"enrolment_options\">\n            <legend class=\"ftoggler\"><a href=\"#\" class=\"fheader\" role=\"button\" aria-controls=\"enrolment_options\" \n                aria-expanded=\"false\">").concat(a.strings[8],"</a></legend>\n            <div class=\"fcontainer\">\n            <div class=\"radio\"><label><input type=\"radio\" id=\"enrol_simplesco_typesearch_classe\" \n                name=\"enrol_simplesco_typesearch\" value=\"classe\" checked=\"checked\"/>").concat(a.strings[9],"</label></div>\n            <div class=\"radio\"><label><input type=\"radio\" id=\"enrol_simplesco_typesearch_ent\" \n                name=\"enrol_simplesco_typesearch\" value=\"ent\"/>").concat(a.strings[10],"</label></div>\n            <div class=\"radio\"><label><input type=\"radio\" id=\"enrol_simplesco_typesearch_nom\" \n                name=\"enrol_simplesco_typesearch\" value=\"nom\"/>").concat(a.strings[11],"</label></div>\n            <div id=\"enrol_simplesco_selects\">\n            <div class=\"form-group\"><label for=\"enrol_simplesco_liste1\">").concat(a.strings[12]," :</label>\n                <select id=\"enrol_simplesco_liste1\" name=\"code1\" style=\"max-width: 300px; width:100%;\"></select></div>\n            <div class=\"form-group\"><label for=\"enrol_simplesco_liste2\">").concat(a.strings[13]," :</label>\n                <select id=\"enrol_simplesco_liste2\" name=\"code2\" style=\"max-width: 300px; width:100%;\"></select></div>\n            <div class=\"form-group\"><label for=\"enrol_simplesco_liste3\">").concat(a.strings[14]," :</label>\n                <select id=\"enrol_simplesco_liste3\" name=\"code3\" style=\"max-width: 300px; width:100%;\"></select></div>\n            <div class=\"form-group\"><label for=\"enrol_simplesco_liste4\">").concat(a.strings[15]," :</label>\n                <select id=\"enrol_simplesco_liste4\" name=\"code4\" style=\"max-width: 300px; width:100%;\"></select></div>\n            <div class=\"form-group\"><label for=\"enrol_simplesco_liste5\">").concat(a.strings[16]," :</label>\n                <select id=\"enrol_simplesco_liste5\" name=\"code5\" style=\"max-width: 300px; width:100%;\"></select></div>\n            </div>\n            <div id=\"enrol_simplesco_input form-group\">\n            <label for=\"enrolusersearch\">").concat(a.strings[17]," :</label>\n                <input type=\"text\" id=\"enrolusersearch\" value=\"\" class=\"form-control\" style=\"max-width: 300px; width:100%;\"/>\n            </div>\n            <div class=\"text-center\"><button class=\"btn btn-primary\" id=\"search\"> ").concat(a.strings[18],"</button></div>\n            </div>\n            </fieldset>\n            <div id=\"results\"></div>\n            <div id=\"loading\" style=\"display:none;\">CHARGEMENT</div>\n            </div>");a.modal.setBody(c);a.modal.setFooter("<button class=\"btn btn-primary\" data-action=\"hide\">".concat(a.strings[1],"</button>"));a.modal.getRoot().on(f.default.hidden,function(){if(a.require_refresh){location.reload()}});a.bindEvents();a.displayLists();a.populateRoles();a.updateStartDateList();a.updateDurationsList()}).catch(d.default.exception)}},{key:"bindEvents",value:function bindEvents(){var a=this;document.addEventListener("click",function(b){if(b.target.closest(m.BUTTON_TRIGGER)){b.preventDefault();a.modal.show()}});this.modal.getBody().find(m.FIELD_TYPE).on("change",function(){a.displayLists()});this.modal.getBody().find(m.BUTTON_COLLAPSE).on("click",function(a){a.preventDefault();a.target.closest(".collapsible").classList.toggle("collapsed");return!1});this.modal.getBody().find("#enrol_simplesco_liste1").on("change",function(b){a.refreshSearchLists(b.target)});this.modal.getBody().find(m.BUTTON_SEARCH).on("click",function(b){b.preventDefault();a.search();return!1});this.modal.getBody().find(m.FIELD_SEARCH).on("keypress",function(b){if(13===b.which){b.preventDefault();a.search();return!1}});this.modal.getBody().on("click",m.BUTTON_LOADMORE,function(b){b.preventDefault();a.search(!0);return!1});this.modal.getBody().on("click",m.BUTTON_ENROL,function(c){c.preventDefault();var d=(0,b.default)(c.target).attr("value");a.enrol(d);return!1})}},{key:"displayLists",value:function displayLists(){switch(this.modal.getBody().find(m.FIELD_TYPE+":checked").val()){case"classe":this.modal.getBody().find("#enrol_simplesco_liste1").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste2").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste3").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste4").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste5").closest(".form-group").hide();this.refreshSearchLists();break;case"ent":this.modal.getBody().find("#enrol_simplesco_liste1").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste2").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste3").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste4").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste5").closest(".form-group").show();this.refreshSearchLists();break;case"nom":this.modal.getBody().find("#enrol_simplesco_liste1").closest(".form-group").hide();this.modal.getBody().find("#enrol_simplesco_liste2").closest(".form-group").hide();this.modal.getBody().find("#enrol_simplesco_liste3").closest(".form-group").hide();this.modal.getBody().find("#enrol_simplesco_liste4").closest(".form-group").hide();this.modal.getBody().find("#enrol_simplesco_liste5").closest(".form-group").hide();break;}}},{key:"enrol",value:function enrol(a){var c=this,e={id:this.course_id,sesskey:M.cfg.sesskey,action:"enrol",enrolid:this.instance.id,userid:a,role:this.modal.getBody().find(m.FIELD_ROLES).val(),startdate:this.modal.getBody().find(m.FIELD_STARTDATE).val(),duration:this.modal.getBody().find(m.FIELD_DURATION).val(),recovergrades:0};b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(e),success:function success(b){if(b.error){return d.default.exception(b)}c.require_refresh=!0;c.enrol_count++;c.modal.getBody().find(m.AREA_RESULTS).find("div.user[rel=\""+a+"\"]").addClass("enrolled")},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){c.startLoading()}}).always(function(){c.stopLoading()})}},{key:"populateRoles",value:function populateRoles(){var a=this;if(0<this.assignales_roles.length){return this.updateRolesList()}b.default.ajax({url:M.cfg.wwwroot+"/enrol/ajax.php",method:"POST",dataType:"json",data:"id="+this.course_id+"&action=getassignable&sesskey="+M.cfg.sesskey,success:function success(b){if(b.error){return d.default.exception(b)}a.assignales_roles=b.response;a.updateRolesList()},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){a.startLoading()}}).always(function(){a.stopLoading()})}},{key:"refreshSearchLists",value:function refreshSearchLists(a){var c=this,e=this.modal.getBody().find("select#enrol_simplesco_liste1").val();if(a==void 0){a="12345"}else if("object"==h(a)){a="345"}if(null===e){e=""}var f={id:this.course_id,action:"getListes",sesskey:M.cfg.sesskey,code1:e,option:this.modal.getBody().find(m.FIELD_TYPE+":checked").val(),numliste:a};b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(f),success:function success(a){if(a.error){return d.default.exception(a)}for(var h=0;h<f.numliste.length;h++){var b=f.numliste.charAt(h),e=c.modal.getBody().find("#enrol_simplesco_liste"+b),g=a.response["defaut"+b];e.html("");if(0==a.response[b].length){e.append("<option value=\"\">".concat(c.strings[19],"</option>"))}else{for(var i in a.response[b]){e.append("<option value=\"".concat(i,"\">").concat(a.response[b][i],"</option>"))}if(1!=b){e.append("<option value=\"\">".concat(c.strings[20],"</option>"))}}e.val(g)}},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){c.startLoading()}}).always(function(){c.stopLoading()})}},{key:"renderUser",value:function renderUser(a){var b=this.modal.getBody().find(m.AREA_RESULTS).find(".user").length,c="<div class=\"user item clearfix\" rel=\"".concat(a.id,"\">\n        <div class=\"count\">").concat(b+1,"</div>\n        <div class=\"picture\">").concat(a.picture,"</div>\n        <div class=\"details\">\n        <div class=\"fullname\">").concat(a.fullname,"</div>\n        <div class=\"extrafields\">").concat(a.extrafields,"</div>\n        </div>\n        <div class=\"options\">\n        <button class=\"btn btn-success\" data-toggle=\"enrol\" value=\"").concat(a.id,"\">").concat(this.strings[23],"</button>\n        </div>\n        </div>");return c}},{key:"search",value:function search(a){var c=this,e;if(a){this.page++}else{this.page=0}if(-1!==["classe","ent"].indexOf(this.modal.getBody().find(m.FIELD_TYPE+":checked").val())){e="ldap"}var f={id:this.course_id,sesskey:M.cfg.sesskey,action:"searchusers",search:this.modal.getBody().find(m.FIELD_SEARCH).val(),option:this.modal.getBody().find(m.FIELD_TYPE+":checked").val(),numliste:"12345",page:this.page,perpage:this.perpage,enrolcount:this.enrol_count,enrolid:this.instance.id,type:e,code1:this.modal.getBody().find("#enrol_simplesco_liste1").val(),code2:this.modal.getBody().find("#enrol_simplesco_liste2").val(),code3:this.modal.getBody().find("#enrol_simplesco_liste3").val(),code4:this.modal.getBody().find("#enrol_simplesco_liste4").val(),code5:this.modal.getBody().find("#enrol_simplesco_liste5").val()};this.modal.getBody().find(m.AREA_RESULTS).find("button[data-toggle=\"load-more\"]").remove();b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(f),success:function success(b){if(b.error){return d.default.exception(b)}if(!a){c.modal.getBody().find(m.AREA_RESULTS).html("");c.modal.getBody().find(m.AREA_RESULTS).append("<div class=\"total_results\">"+c.strings[21].replace("{$a}",b.response.totalusers)+"</div>")}for(var f in b.response.users){var g=b.response.users[f];c.modal.getBody().find(m.AREA_RESULTS).append(c.renderUser(g))}var e=c.modal.getBody().find(m.AREA_RESULTS).find(".item").length;if(e<b.response.totalusers){c.modal.getBody().find(m.AREA_RESULTS).append("<div class=\"text-center\"><button class=\"btn btn-secondary\" data-toggle=\"load-more\">"+c.strings[22]+"</button></div>")}},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){c.startLoading()}}).always(function(){c.stopLoading()})}},{key:"startLoading",value:function startLoading(){this.modal.getBody().find("#loading").show()}},{key:"stopLoading",value:function stopLoading(){this.modal.getBody().find("#loading").hide()}},{key:"updateRolesList",value:function updateRolesList(){var a=this.modal.getBody().find(m.FIELD_ROLES);for(var c in this.assignales_roles){var d=this.role_default==this.assignales_roles[c].id?"selected=\"selected\"":"";(0,b.default)(a).append("<option value=\"".concat(this.assignales_roles[c].id,"\" ").concat(d,">").concat(this.assignales_roles[c].name,"</option>"))}}},{key:"updateDurationsList",value:function updateDurationsList(){var a=this.modal.getBody().find(m.FIELD_DURATION);b.default.when((0,c.get_string)("durationdays","enrol","{a}")).then(function(c){for(var d=1;365>=d;d++){(0,b.default)(a).append("<option value=\"".concat(d,"\">")+c.replace("{a}",d)+"</option>")}})}},{key:"updateStartDateList",value:function updateStartDateList(){var a=this.modal.getBody().find(m.FIELD_STARTDATE);for(var c in this.start_dates){(0,b.default)(a).append("<option value=\"".concat(c,"\">").concat(this.start_dates[c],"</option>"))}}}]);return a}();a.init=function init(a){new n(a)}});
//# sourceMappingURL=userenrolment.min.js.map
