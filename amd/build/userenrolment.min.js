define ("enrol_simplesco/userenrolment",["exports","jquery","core/str","core/notification","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=g(b);c=g(c);d=g(d);e=g(e);f=g(f);var j=void 0;function g(a){return a&&a.__esModule?a:{default:a}}function h(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){h=function(a){return typeof a}}else{h=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return h(a)}var k={BUTTON_TRIGGER:"button#enrol_simplesco_adduser",BUTTON_COLLAPSE:".collapsible .ftoggler a",BUTTON_LOADMORE:"button[data-toggle=\"load-more\"]",BUTTON_ENROL:"button[data-toggle=\"enrol\"]",BUTTON_SEARCH:"button#search",FIELD_TYPE:"input[name=\"enrol_simplesco_typesearch\"]",FIELD_ROLES:"select#enrol_simplesco_assignable_roles",FIELD_DURATION:"select#enrol_simplesco_assignable_duration",FIELD_SEARCH:"input#enrolusersearch",FIELD_STARTDATE:"select#enrol_simplesco_assignable_startdate",AREA_RESULTS:"div#results"},l=function(a){j.course_id=a.course_id;j.instance=a.instance;j.start_dates=a.start_dates;j.role_default=a.role_default;j.init()};l.prototype.modal=null;l.prototype.page=0;l.prototype.perpage=25;l.prototype.course_id=0;l.prototype.role_default=0;l.prototype.enrol_count=0;l.prototype.assignales_roles=[];l.prototype.instance=[];l.prototype.start_dates=[];l.prototype.require_refresh=!1;l.prototype.modal=null;l.prototype.init=function(){b.default.when(c.default.get_strings([{component:"enrol",key:"enrolusers"},{component:"enrol",key:"finishenrollingusers"},{component:"role",key:"assignroles"},{component:"enrol",key:"none"},{component:"enrol",key:"enrolmentoptions"},{component:"moodle",key:"startingfrom"},{component:"enrol",key:"enrolperiod"},{component:"enrol",key:"unlimitedduration"},{component:"enrol_simplesco",key:"searchoption"},{component:"enrol_simplesco",key:"frommyclass"},{component:"enrol_simplesco",key:"fromnetocentre"},{component:"enrol_simplesco",key:"byname"},{component:"enrol_simplesco",key:"fitre1name"},{component:"enrol_simplesco",key:"fitre2name"},{component:"enrol_simplesco",key:"fitre3name"},{component:"enrol_simplesco",key:"fitre4name"},{component:"enrol_simplesco",key:"fitre5name"},{component:"enrol_simplesco",key:"fitre6name"},{component:"enrol",key:"usersearch"},{component:"enrol_simplesco",key:"noresultliste"},{component:"enrol_simplesco",key:"allresultliste"},{component:"enrol",key:"ajaxxusersfound"},{component:"enrol",key:"ajaxnext25"},{component:"enrol",key:"enrol"}]),e.default.create({type:e.default.types.DEFAULT,large:!0},void 0)).then(function(a,b){this.strings=a;this.modal=b;b.setTitle(a[0]);var c="<div class=\"form-inline mform simplesco\">";c+="<div class=\"form-group\">";c+="<label for=\"enrol_simplesco_assignable_roles\">"+a[2]+" : </label>";c+="<select id=\"enrol_simplesco_assignable_roles\"><option value=\"\">"+a[3]+"</option></select>";c+="</div>";c+="<fieldset class=\"collapsible collapsed\" id=\"enrolment_options\">";c+="<legend class=\"ftoggler\"><a href=\"#\" class=\"fheader\" role=\"button\" aria-controls=\"enrolment_options\" aria-expanded=\"false\">"+a[4]+"</a></legend>";c+="<div class=\"fcontainer\">";c+="<div class=\"startdate form-group\"><label for=\"enrol_simplesco_assignable_startdate\">"+a[5]+":</label> <select id=\"enrol_simplesco_assignable_startdate\"></select></div>";c+="<div class=\"duration form-group\"><label for=\"enrol_simplesco_assignable_duration\">"+a[6]+" :</label> <select id=\"enrol_simplesco_assignable_duration\"><option value=\"0\" selected=\"selected\">"+a[7]+"</option></select></div>";c+="</div>";c+="</fieldset>";c+="<fieldset class=\"collapsible\" id=\"enrolment_options\">";c+="<legend class=\"ftoggler\"><a href=\"#\" class=\"fheader\" role=\"button\" aria-controls=\"enrolment_options\" aria-expanded=\"false\">"+a[8]+"</a></legend>";c+="<div class=\"fcontainer\">";c+="<div class=\"radio\"><label><input type=\"radio\" id=\"enrol_simplesco_typesearch_classe\" name=\"enrol_simplesco_typesearch\" value=\"classe\" checked=\"checked\"/>"+a[9]+"</label></div>";c+="<div class=\"radio\"><label><input type=\"radio\" id=\"enrol_simplesco_typesearch_ent\" name=\"enrol_simplesco_typesearch\" value=\"ent\"/>"+a[10]+"</label></div>";c+="<div class=\"radio\"><label><input type=\"radio\" id=\"enrol_simplesco_typesearch_nom\" name=\"enrol_simplesco_typesearch\" value=\"nom\"/>"+a[11]+"</label></div>";c+="<div id=\"enrol_simplesco_selects\">";c+="<div class=\"form-group\"><label for=\"enrol_simplesco_liste1\">"+a[12]+" :</label><select id=\"enrol_simplesco_liste1\" name=\"code1\" style=\"max-width: 300px; width:100%;\"></select></div>";c+="<div class=\"form-group\"><label for=\"enrol_simplesco_liste2\">"+a[13]+" :</label><select id=\"enrol_simplesco_liste2\" name=\"code2\" style=\"max-width: 300px; width:100%;\"></select></div>";c+="<div class=\"form-group\"><label for=\"enrol_simplesco_liste3\">"+a[14]+" :</label><select id=\"enrol_simplesco_liste3\" name=\"code3\" style=\"max-width: 300px; width:100%;\"></select></div>";c+="<div class=\"form-group\"><label for=\"enrol_simplesco_liste4\">"+a[15]+" :</label><select id=\"enrol_simplesco_liste4\" name=\"code4\" style=\"max-width: 300px; width:100%;\"></select></div>";c+="<div class=\"form-group\"><label for=\"enrol_simplesco_liste5\">"+a[16]+" :</label><select id=\"enrol_simplesco_liste5\" name=\"code5\" style=\"max-width: 300px; width:100%;\"></select></div>";c+="</div>";c+="<div id=\"enrol_simplesco_input form-group\">";c+="<label for=\"enrolusersearch\">"+a[17]+" :</label> <input type=\"text\" id=\"enrolusersearch\" value=\"\" class=\"form-control\" style=\"max-width: 300px; width:100%;\"/>";c+="</div>";c+="<div class=\"text-center\"><button class=\"btn btn-primary\" id=\"search\"> "+a[18]+"</button></div>";c+="</div>";c+="</fieldset>";c+="<div id=\"results\"></div>";c+="<div id=\"loading\" style=\"display:none;\">CHARGEMENT</div>";c+="</div>";b.setBody(c);b.setFooter("<button class=\"btn btn-primary\" data-action=\"hide\">"+a[1]+"</button>");b.getRoot().on(f.default.hidden,function(){if((void 0).require_refresh){location.reload()}});this.bindEvents();this.displayLists();this.populateRoles();this.updateStartDateList();this.updateDurationsList()}.bind(j)).fail(d.default.exception)};l.prototype.bindEvents=function(){(0,b.default)("body").on("click",k.BUTTON_TRIGGER,function(){(void 0).modal.show()});j.modal.getBody().find(k.FIELD_TYPE).on("change",function(){(void 0).displayLists()});j.modal.getBody().find(k.BUTTON_COLLAPSE).on("click",function(a){a.preventDefault();(0,b.default)(j).closest(".collapsible").toggleClass("collapsed");return!1});j.modal.getBody().find("#enrol_simplesco_liste1").on("change",function(){(void 0).refreshSearchLists(j)});j.modal.getBody().find(k.BUTTON_SEARCH).on("click",function(a){a.preventDefault();(void 0).search();return!1});j.modal.getBody().find(k.FIELD_SEARCH).on("keypress",function(a){if(13===a.which){a.preventDefault();(void 0).search();return!1}});j.modal.getBody().on("click",k.BUTTON_LOADMORE,function(a){a.preventDefault();(void 0).search(!0);return!1});j.modal.getBody().on("click",k.BUTTON_ENROL,function(a){a.preventDefault();var c=(0,b.default)(j).attr("value");(void 0).enrol(c);return!1})};l.prototype.displayLists=function(){switch(j.modal.getBody().find(k.FIELD_TYPE+":checked").val()){case"classe":j.modal.getBody().find("#enrol_simplesco_liste1").closest(".form-group").show();j.modal.getBody().find("#enrol_simplesco_liste2").closest(".form-group").show();j.modal.getBody().find("#enrol_simplesco_liste3").closest(".form-group").show();j.modal.getBody().find("#enrol_simplesco_liste4").closest(".form-group").show();j.modal.getBody().find("#enrol_simplesco_liste5").closest(".form-group").hide();j.refreshSearchLists();break;case"ent":j.modal.getBody().find("#enrol_simplesco_liste1").closest(".form-group").show();j.modal.getBody().find("#enrol_simplesco_liste2").closest(".form-group").show();j.modal.getBody().find("#enrol_simplesco_liste3").closest(".form-group").show();j.modal.getBody().find("#enrol_simplesco_liste4").closest(".form-group").show();j.modal.getBody().find("#enrol_simplesco_liste5").closest(".form-group").show();j.refreshSearchLists();break;case"nom":j.modal.getBody().find("#enrol_simplesco_liste1").closest(".form-group").hide();j.modal.getBody().find("#enrol_simplesco_liste2").closest(".form-group").hide();j.modal.getBody().find("#enrol_simplesco_liste3").closest(".form-group").hide();j.modal.getBody().find("#enrol_simplesco_liste4").closest(".form-group").hide();j.modal.getBody().find("#enrol_simplesco_liste5").closest(".form-group").hide();break;}};l.prototype.enrol=function(a){var c={id:j.course_id,sesskey:M.cfg.sesskey,action:"enrol",enrolid:j.instance.id,userid:a,role:j.modal.getBody().find(k.FIELD_ROLES).val(),startdate:j.modal.getBody().find(k.FIELD_STARTDATE).val(),duration:j.modal.getBody().find(k.FIELD_DURATION).val(),recovergrades:0};b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(c),success:function success(b){if(b.error){return d.default.exception(b)}(void 0).require_refresh=!0;(void 0).enrol_count++;(void 0).modal.getBody().find(k.AREA_RESULTS).find("div.user[rel=\""+a+"\"]").addClass("enrolled")},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){(void 0).startLoading()}}).always(function(){(void 0).stopLoading()})};l.prototype.populateRoles=function(){if(0<j.assignales_roles.length){return j.updateRolesList()}b.default.ajax({url:M.cfg.wwwroot+"/enrol/ajax.php",method:"POST",dataType:"json",data:"id="+j.course_id+"&action=getassignable&sesskey="+M.cfg.sesskey,success:function success(a){if(a.error){return d.default.exception(a)}(void 0).assignales_roles=a.response;(void 0).updateRolesList()},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){(void 0).startLoading()}}).always(function(){(void 0).stopLoading()})};l.prototype.refreshSearchLists=function(a){var c=j.modal.getBody().find("select#enrol_simplesco_liste1").val();if(a==void 0){a="12345"}else if("object"==h(a)){a="345"}if(null===c){c=""}var e={id:j.course_id,action:"getListes",sesskey:M.cfg.sesskey,code1:c,option:j.modal.getBody().find(k.FIELD_TYPE+":checked").val(),numliste:a},f=j;b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(e),success:function success(a){if(a.error){return d.default.exception(a)}for(var h=0;h<e.numliste.length;h++){var b=e.numliste.charAt(h),c=f.modal.getBody().find("#enrol_simplesco_liste"+b),g=a.response["defaut"+b];c.html("");if(0==a.response[b].length){c.append("<option value=\"\">"+f.strings[19]+"</option>")}else{for(var i in a.response[b]){c.append("<option value=\""+i+"\">"+a.response[b][i]+"</option>")}if(1!=b){c.append("<option value=\"\">"+f.strings[20]+"</option>")}}c.val(g)}},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){f.startLoading()}}).always(function(){f.stopLoading()})};l.prototype.renderUser=function(a){var b=j.modal.getBody().find(k.AREA_RESULTS).find(".user").length,c="<div class=\"user item clearfix\" rel=\""+a.id+"\">";c+="<div class=\"count\">"+(b+1)+"</div>";c+="<div class=\"picture\">"+a.picture+"</div>";c+="<div class=\"details\">";c+="<div class=\"fullname\">"+a.fullname+"</div>";c+="<div class=\"extrafields\">"+a.extrafields+"</div>";c+="</div>";c+="<div class=\"options\">";c+="<button class=\"btn btn-success\" data-toggle=\"enrol\" value=\""+a.id+"\">"+j.strings[23]+"</button>";c+="</div>";c+="</div>";return c};l.prototype.search=function(a){var c;if(a){j.page++}else{j.page=0}if(-1!==["classe","ent"].indexOf(j.modal.getBody().find(k.FIELD_TYPE+":checked").val())){c="ldap"}var e={id:j.course_id,sesskey:M.cfg.sesskey,action:"searchusers",search:j.modal.getBody().find(k.FIELD_SEARCH).val(),option:j.modal.getBody().find(k.FIELD_TYPE+":checked").val(),numliste:"12345",page:j.page,perpage:j.perpage,enrolcount:j.enrol_count,enrolid:j.instance.id,type:c,code1:j.modal.getBody().find("#enrol_simplesco_liste1").val(),code2:j.modal.getBody().find("#enrol_simplesco_liste2").val(),code3:j.modal.getBody().find("#enrol_simplesco_liste3").val(),code4:j.modal.getBody().find("#enrol_simplesco_liste4").val(),code5:j.modal.getBody().find("#enrol_simplesco_liste5").val()};(void 0).modal.getBody().find(k.AREA_RESULTS).find("button[data-toggle=\"load-more\"]").remove();b.default.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(e),success:function success(b){if(b.error){return d.default.exception(b)}if(!a){(void 0).modal.getBody().find(k.AREA_RESULTS).html("");(void 0).modal.getBody().find(k.AREA_RESULTS).append("<div class=\"total_results\">"+(void 0).strings[21].replace("{$a}",b.response.totalusers)+"</div>")}for(var e in b.response.users){var f=b.response.users[e];(void 0).modal.getBody().find(k.AREA_RESULTS).append((void 0).renderUser(f))}var c=(void 0).modal.getBody().find(k.AREA_RESULTS).find(".item").length;if(c<b.response.totalusers){(void 0).modal.getBody().find(k.AREA_RESULTS).append("<div class=\"text-center\"><button class=\"btn btn-secondary\" data-toggle=\"load-more\">"+(void 0).strings[22]+"</button></div>")}},error:function error(a,b,c){d.default.exception(c)},beforeSend:function beforeSend(){(void 0).startLoading()}}).always(function(){(void 0).stopLoading()})};l.prototype.startLoading=function(){j.modal.getBody().find("#loading").show()};l.prototype.stopLoading=function(){j.modal.getBody().find("#loading").hide()};l.prototype.updateRolesList=function(){var a=j.modal.getBody().find(k.FIELD_ROLES);for(var c in j.assignales_roles){var d=j.role_default==j.assignales_roles[c].id?"selected=\"selected\"":"";(0,b.default)(a).append("<option value=\""+j.assignales_roles[c].id+"\" "+d+">"+j.assignales_roles[c].name+"</option>")}};l.prototype.updateDurationsList=function(){var a=j.modal.getBody().find(k.FIELD_DURATION);b.default.when(c.default.get_string("durationdays","enrol","{a}")).then(function(c){for(var d=1;365>=d;d++){(0,b.default)(a).append("<option value=\""+d+"\">"+c.replace("{a}",d)+"</option>")}})};l.prototype.updateStartDateList=function(){var a=j.modal.getBody().find(k.FIELD_STARTDATE);for(var c in j.start_dates){(0,b.default)(a).append("<option value=\""+c+"\">"+j.start_dates[c]+"</option>")}};a.init=function init(a){new l(a)}});
//# sourceMappingURL=userenrolment.min.js.map
