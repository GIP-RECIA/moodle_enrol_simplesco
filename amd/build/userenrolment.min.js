/*
  2016 Damyon Wiese <damyon@moodle.com>
 @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,f,g){b instanceof String&&(b=String(b));for(var l=b.length,h=0;h<l;h++){var m=b[h];if(f.call(g,m,h,b))return{i:h,v:m}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,f,g){b!=Array.prototype&&b!=Object.prototype&&(b[f]=g.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,f,g,l){if(f){g=$jscomp.global;b=b.split(".");for(l=0;l<b.length-1;l++){var h=b[l];h in g||(g[h]={});g=g[h]}b=b[b.length-1];l=g[b];f=f(l);f!=l&&null!=f&&$jscomp.defineProperty(g,b,{configurable:!0,writable:!0,value:f})}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,g){return $jscomp.findInternal(this,b,g).v}},"es6","es3");
define('userenrolment',"core/templates jquery core/str core/config core/notification core/yui core/modal_factory core/modal_events core/fragment".split(" "),function(b,f,g,l,h,m,n,p,q){var e=function(c){this.course_id=c.course_id;this.instance=c.instance;this.start_dates=c.start_dates;this.role_default=c.role_default;this.init()};e.prototype.modal=null;e.prototype.page=0;e.prototype.perpage=25;e.prototype.course_id=0;e.prototype.role_default=0;e.prototype.enrol_count=0;e.prototype.assignales_roles=[];e.prototype.instance=
[];e.prototype.start_dates=[];e.prototype.require_refresh=!1;e.prototype.modal=null;e.prototype.init=function(){var c=this;f.when(g.get_strings([{component:"enrol",key:"enrolusers"},{component:"enrol",key:"finishenrollingusers"},{component:"role",key:"assignroles"},{component:"enrol",key:"none"},{component:"enrol",key:"enrolmentoptions"},{component:"moodle",key:"startingfrom"},{component:"enrol",key:"enrolperiod"},{component:"enrol",key:"unlimitedduration"},{component:"enrol_simplesco",key:"searchoption"},
{component:"enrol_simplesco",key:"frommyclass"},{component:"enrol_simplesco",key:"fromnetocentre"},{component:"enrol_simplesco",key:"byname"},{component:"enrol_simplesco",key:"fitre1name"},{component:"enrol_simplesco",key:"fitre2name"},{component:"enrol_simplesco",key:"fitre3name"},{component:"enrol_simplesco",key:"fitre4name"},{component:"enrol_simplesco",key:"fitre5name"},{component:"enrol_simplesco",key:"fitre6name"},{component:"enrol",key:"usersearch"},{component:"enrol_simplesco",key:"noresultliste"},
{component:"enrol_simplesco",key:"allresultliste"},{component:"enrol",key:"ajaxxusersfound"},{component:"enrol",key:"ajaxnext25"},{component:"enrol",key:"enrol"}]),n.create({type:n.types.DEFAULT,large:!0},void 0)).then(function(a,k){this.strings=a;this.modal=k;k.setTitle(a[0]);var d='<div class="form-inline mform simplesco"><div class="form-group">'+('<label for="enrol_simplesco_assignable_roles">'+a[2]+" : </label>");d+='<select id="enrol_simplesco_assignable_roles"><option value="">'+a[3]+"</option></select>";
d=d+'</div><fieldset class="collapsible collapsed" id="enrolment_options">'+('<legend class="ftoggler"><a href="#" class="fheader" role="button" aria-controls="enrolment_options" aria-expanded="false">'+a[4]+"</a></legend>");d=d+'<div class="fcontainer">'+('<div class="startdate form-group"><label for="enrol_simplesco_assignable_startdate">'+a[5]+':</label> <select id="enrol_simplesco_assignable_startdate"></select></div>');d+='<div class="duration form-group"><label for="enrol_simplesco_assignable_duration">'+
a[6]+' :</label> <select id="enrol_simplesco_assignable_duration"><option value="0" selected="selected">'+a[7]+"</option></select></div>";d=d+'</div></fieldset><fieldset class="collapsible" id="enrolment_options">'+('<legend class="ftoggler"><a href="#" class="fheader" role="button" aria-controls="enrolment_options" aria-expanded="false">'+a[8]+"</a></legend>");d=d+'<div class="fcontainer">'+('<div class="radio"><label><input type="radio" id="enrol_simplesco_typesearch_classe" name="enrol_simplesco_typesearch" value="classe" checked="checked"/>'+
a[9]+"</label></div>");d+='<div class="radio"><label><input type="radio" id="enrol_simplesco_typesearch_ent" name="enrol_simplesco_typesearch" value="ent"/>'+a[10]+"</label></div>";d+='<div class="radio"><label><input type="radio" id="enrol_simplesco_typesearch_nom" name="enrol_simplesco_typesearch" value="nom"/>'+a[11]+"</label></div>";d=d+'<div id="enrol_simplesco_selects">'+('<div class="form-group"><label for="enrol_simplesco_liste1">'+a[12]+' :</label><select id="enrol_simplesco_liste1" name="code1" style="max-width: 300px; width:100%;"></select></div>');
d+='<div class="form-group"><label for="enrol_simplesco_liste2">'+a[13]+' :</label><select id="enrol_simplesco_liste2" name="code2" style="max-width: 300px; width:100%;"></select></div>';d+='<div class="form-group"><label for="enrol_simplesco_liste3">'+a[14]+' :</label><select id="enrol_simplesco_liste3" name="code3" style="max-width: 300px; width:100%;"></select></div>';d+='<div class="form-group"><label for="enrol_simplesco_liste4">'+a[15]+' :</label><select id="enrol_simplesco_liste4" name="code4" style="max-width: 300px; width:100%;"></select></div>';
d+='<div class="form-group"><label for="enrol_simplesco_liste5">'+a[16]+' :</label><select id="enrol_simplesco_liste5" name="code5" style="max-width: 300px; width:100%;"></select></div>';d=d+'</div><div id="enrol_simplesco_input form-group">'+('<label for="enrolusersearch">'+a[17]+' :</label> <input type="text" id="enrolusersearch" value="" class="form-control" style="max-width: 300px; width:100%;"/>');d=d+"</div>"+('<div class="text-center"><button class="btn btn-primary" id="search"> '+a[18]+"</button></div>");
k.setBody(d+'</div></fieldset><div id="results"></div><div id="loading" style="display:none;">CHARGEMENT</div></div>');k.setFooter('<button class="btn btn-primary" data-action="hide">'+a[1]+"</button>");k.getRoot().on(p.hidden,function(){c.require_refresh&&location.reload()});this.bindEvents();this.displayLists();this.populateRoles();this.updateStartDateList();this.updateDurationsList()}.bind(this)).fail(h.exception)};e.prototype.bindEvents=function(){var c=this;f("body").on("click","button#enrol_simplesco_adduser",
function(){c.modal.show()});this.modal.getBody().find('input[name="enrol_simplesco_typesearch"]').on("change",function(){c.displayLists()});this.modal.getBody().find(".collapsible .ftoggler a").on("click",function(a){a.preventDefault();f(this).closest(".collapsible").toggleClass("collapsed");return!1});this.modal.getBody().find("#enrol_simplesco_liste1").on("change",function(){c.refreshSearchLists(this)});this.modal.getBody().find("button#search").on("click",function(a){a.preventDefault();c.search();
return!1});this.modal.getBody().find("input#enrolusersearch").on("keypress",function(a){if(13===a.which)return a.preventDefault(),c.search(),!1});this.modal.getBody().on("click",'button[data-toggle="load-more"]',function(a){a.preventDefault();c.search(!0);return!1});this.modal.getBody().on("click",'button[data-toggle="enrol"]',function(a){a.preventDefault();a=f(this).attr("value");c.enrol(a);return!1})};e.prototype.displayLists=function(){switch(this.modal.getBody().find('input[name="enrol_simplesco_typesearch"]:checked').val()){case "classe":this.modal.getBody().find("#enrol_simplesco_liste1").closest(".form-group").show();
this.modal.getBody().find("#enrol_simplesco_liste2").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste3").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste4").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste5").closest(".form-group").hide();this.refreshSearchLists();break;case "ent":this.modal.getBody().find("#enrol_simplesco_liste1").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste2").closest(".form-group").show();
this.modal.getBody().find("#enrol_simplesco_liste3").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste4").closest(".form-group").show();this.modal.getBody().find("#enrol_simplesco_liste5").closest(".form-group").show();this.refreshSearchLists();break;case "nom":this.modal.getBody().find("#enrol_simplesco_liste1").closest(".form-group").hide(),this.modal.getBody().find("#enrol_simplesco_liste2").closest(".form-group").hide(),this.modal.getBody().find("#enrol_simplesco_liste3").closest(".form-group").hide(),
this.modal.getBody().find("#enrol_simplesco_liste4").closest(".form-group").hide(),this.modal.getBody().find("#enrol_simplesco_liste5").closest(".form-group").hide()}};e.prototype.enrol=function(c){var a=this,k={id:this.course_id,sesskey:M.cfg.sesskey,action:"enrol",enrolid:this.instance.id,userid:c,role:this.modal.getBody().find("select#enrol_simplesco_assignable_roles").val(),startdate:this.modal.getBody().find("select#enrol_simplesco_assignable_startdate").val(),duration:this.modal.getBody().find("select#enrol_simplesco_assignable_duration").val(),
recovergrades:0};f.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(k),success:function(d,k){if(d.error)return h.exception(d);a.require_refresh=!0;a.enrol_count++;a.modal.getBody().find("div#results").find('div.user[rel="'+c+'"]').addClass("enrolled")},error:function(a,c,k){h.exception(k)},beforeSend:function(){a.startLoading()}}).always(function(){a.stopLoading()})};e.prototype.populateRoles=function(){if(0<this.assignales_roles.length)return this.updateRolesList();
var c=this;f.ajax({url:M.cfg.wwwroot+"/enrol/ajax.php",method:"POST",dataType:"json",data:"id="+this.course_id+"&action=getassignable&sesskey="+M.cfg.sesskey,success:function(a,k){if(a.error)return h.exception(a);c.assignales_roles=a.response;c.updateRolesList()},error:function(a,c,d){h.exception(d)},beforeSend:function(){c.startLoading()}}).always(function(){c.stopLoading()})};e.prototype.refreshSearchLists=function(c){var a=this.modal.getBody().find("select#enrol_simplesco_liste1").val();void 0==
c?c="12345":"object"==typeof c&&(c="345");null==a&&(a="");var k={id:this.course_id,action:"getListes",sesskey:M.cfg.sesskey,code1:a,option:this.modal.getBody().find('input[name="enrol_simplesco_typesearch"]:checked').val(),numliste:c},d=this;f.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(k),success:function(a,c){if(a.error)return h.exception(a);for(c=0;c<k.numliste.length;c++){var b=k.numliste.charAt(c),e=d.modal.getBody().find("#enrol_simplesco_liste"+
b),f=a.response["defaut"+b];e.html("");if(0==a.response[b].length)e.append('<option value="">'+d.strings[19]+"</option>");else{for(var g in a.response[b])e.append('<option value="'+g+'">'+a.response[b][g]+"</option>");1!=b&&e.append('<option value="">'+d.strings[20]+"</option>")}e.val(f)}},error:function(a,c,d){h.exception(d)},beforeSend:function(){d.startLoading()}}).always(function(){d.stopLoading()})};e.prototype.renderUser=function(c){var a=this.modal.getBody().find("div#results").find(".user").length,
b='<div class="user item clearfix" rel="'+c.id+'">';b=b+('<div class="count">'+(a+1)+"</div>")+('<div class="picture">'+c.picture+"</div>");b=b+'<div class="details">'+('<div class="fullname">'+c.fullname+"</div>");b+='<div class="extrafields">'+c.extrafields+"</div>";b=b+'</div><div class="options">'+('<button class="btn btn-success" data-toggle="enrol" value="'+c.id+'">'+this.strings[23]+"</button>");return b+"</div></div>"};e.prototype.search=function(c){var a=this,b;c?this.page++:this.page=0;
-1!==["classe","ent"].indexOf(this.modal.getBody().find('input[name="enrol_simplesco_typesearch"]:checked').val())&&(b="ldap");b={id:this.course_id,sesskey:M.cfg.sesskey,action:"searchusers",search:this.modal.getBody().find("input#enrolusersearch").val(),option:this.modal.getBody().find('input[name="enrol_simplesco_typesearch"]:checked').val(),numliste:"12345",page:this.page,perpage:this.perpage,enrolcount:this.enrol_count,enrolid:this.instance.id,type:b,code1:this.modal.getBody().find("#enrol_simplesco_liste1").val(),
code2:this.modal.getBody().find("#enrol_simplesco_liste2").val(),code3:this.modal.getBody().find("#enrol_simplesco_liste3").val(),code4:this.modal.getBody().find("#enrol_simplesco_liste4").val(),code5:this.modal.getBody().find("#enrol_simplesco_liste5").val()};a.modal.getBody().find("div#results").find('button[data-toggle="load-more"]').remove();f.ajax({url:M.cfg.wwwroot+"/enrol/simplesco/ajax.php",method:"POST",dataType:"json",data:build_querystring(b),success:function(b,e){if(b.error)return h.exception(b);
c||(a.modal.getBody().find("div#results").html(""),a.modal.getBody().find("div#results").append('<div class="total_results">'+a.strings[21].replace("{$a}",b.response.totalusers)+"</div>"));for(var d in b.response.users)e=b.response.users[d],a.modal.getBody().find("div#results").append(a.renderUser(e));a.modal.getBody().find("div#results").find(".item").length<b.response.totalusers&&a.modal.getBody().find("div#results").append('<div class="text-center"><button class="btn btn-secondary" data-toggle="load-more">'+
a.strings[22]+"</button></div>")},error:function(a,b,c){h.exception(c)},beforeSend:function(){a.startLoading()}}).always(function(){a.stopLoading()})};e.prototype.startLoading=function(){this.modal.getBody().find("#loading").show()};e.prototype.stopLoading=function(){this.modal.getBody().find("#loading").hide()};e.prototype.updateRolesList=function(){var b=this.modal.getBody().find("select#enrol_simplesco_assignable_roles"),a;for(a in this.assignales_roles){var e=this.role_default==this.assignales_roles[a].id?
'selected="selected"':"";f(b).append('<option value="'+this.assignales_roles[a].id+'" '+e+">"+this.assignales_roles[a].name+"</option>")}};e.prototype.updateDurationsList=function(){var b=this.modal.getBody().find("select#enrol_simplesco_assignable_duration");f.when(g.get_string("durationdays","enrol","{a}")).then(function(a){for(var c=1;365>=c;c++)f(b).append('<option value="'+c+'">'+a.replace("{a}",c)+"</option>")})};e.prototype.updateStartDateList=function(){var b=this.modal.getBody().find("select#enrol_simplesco_assignable_startdate"),
a;for(a in this.start_dates)f(b).append('<option value="'+a+'">'+this.start_dates[a]+"</option>")};return{init:function(b){new e(b)}}});
